<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>向量化煉金工坊 V2 | Vector Alchemy Workshop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* ============================================
           CSS 變數系統
           ============================================ */
        :root {
            /* 煉金術配色 - 金色、銅色、深紫 */
            --gold-bright: #ffd700;
            --gold-main: #d4a84b;
            --gold-light: #e8c87a;
            --gold-dark: #8b7355;
            --gold-glow: rgba(212, 168, 75, 0.4);
            
            --copper: #b87333;
            --copper-light: #cd8844;
            --copper-dark: #8b4513;
            
            --mystic-purple: #2d1b4e;
            --mystic-deep: #1a0f2e;
            --mystic-black: #0d0715;
            --mystic-light: #3d2b5e;
            
            --parchment: #f4e4c1;
            --parchment-light: #faf3e3;
            --parchment-dark: #d4c4a1;
            --ink: #2c2416;
            
            --success: #4ade80;
            --success-dark: #22c55e;
            --error: #ef4444;
            --error-dark: #dc2626;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --info: #3b82f6;
            --info-dark: #2563eb;
            
            /* 字體 */
            --font-display: 'Cinzel', serif;
            --font-body: 'Noto Sans TC', sans-serif;
            --font-accent: 'Playfair Display', serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            /* 尺寸 */
            --radius-xs: 2px;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* 陰影 */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
            --shadow-xl: 0 16px 48px rgba(0,0,0,0.6);
            --shadow-glow: 0 0 30px var(--gold-glow);
            
            /* 過渡 */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            
            /* 層級 */
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-modal: 1000;
            --z-toast: 2000;
            --z-splash: 9999;
            
            /* 佈局 */
            --header-height: 64px;
            --sidebar-width: 320px;
            --toolbar-height: 48px;
        }
        
        /* 淺色主題 */
        [data-theme="light"] {
            --bg-primary: #f8f5f0;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0ebe3;
            --text-primary: #2c2416;
            --text-secondary: #5a4d3a;
            --text-dim: #8b7355;
            --border-color: rgba(44, 36, 22, 0.15);
            --border-light: rgba(44, 36, 22, 0.08);
        }
        
        /* 深色主題（預設） */
        [data-theme="dark"], :root {
            --bg-primary: var(--mystic-black);
            --bg-secondary: var(--mystic-deep);
            --bg-tertiary: var(--mystic-purple);
            --text-primary: var(--parchment);
            --text-secondary: var(--parchment-dark);
            --text-dim: var(--gold-dark);
            --border-color: rgba(212, 168, 75, 0.2);
            --border-light: rgba(212, 168, 75, 0.1);
        }
        
        /* ============================================
           重置與基礎
           ============================================ */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        a {
            color: var(--gold-main);
            text-decoration: none;
        }
        
        button {
            font-family: inherit;
            cursor: pointer;
        }
        
        input, textarea, select {
            font-family: inherit;
        }
        
        img, svg {
            max-width: 100%;
            height: auto;
        }
        
        /* ============================================
           啟動畫面
           ============================================ */
        .splash-screen {
            position: fixed;
            inset: 0;
            background: var(--mystic-black);
            z-index: var(--z-splash);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }
        
        .splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .splash-bg {
            position: absolute;
            inset: 0;
            overflow: hidden;
        }
        
        .splash-circle {
            position: absolute;
            border: 1px solid rgba(212, 168, 75, 0.15);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .splash-circle:nth-child(1) {
            width: 200px;
            height: 200px;
            animation: splash-rotate 10s linear infinite;
        }
        
        .splash-circle:nth-child(2) {
            width: 350px;
            height: 350px;
            animation: splash-rotate 15s linear infinite reverse;
            border-style: dashed;
        }
        
        .splash-circle:nth-child(3) {
            width: 500px;
            height: 500px;
            animation: splash-rotate 20s linear infinite;
        }
        
        .splash-circle:nth-child(4) {
            width: 650px;
            height: 650px;
            animation: splash-rotate 25s linear infinite reverse;
            border-style: dotted;
        }
        
        @keyframes splash-rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .splash-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }
        
        .splash-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 32px;
            position: relative;
        }
        
        .splash-logo-inner {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--gold-bright), var(--copper));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            box-shadow: var(--shadow-glow);
            animation: splash-pulse 2s ease-in-out infinite;
        }
        
        @keyframes splash-pulse {
            0%, 100% { 
                box-shadow: 0 0 30px var(--gold-glow);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 60px var(--gold-glow), 0 0 100px rgba(212, 168, 75, 0.2);
                transform: scale(1.05);
            }
        }
        
        .splash-ring {
            position: absolute;
            inset: -15px;
            border: 2px solid var(--gold-main);
            border-radius: 50%;
            animation: splash-ring-rotate 8s linear infinite;
        }
        
        .splash-ring::before,
        .splash-ring::after {
            content: '✧';
            position: absolute;
            color: var(--gold-bright);
            font-size: 1rem;
        }
        
        .splash-ring::before {
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .splash-ring::after {
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        @keyframes splash-ring-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .splash-title {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gold-bright), var(--copper), var(--gold-main));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.15em;
            margin-bottom: 8px;
            animation: splash-glow 2s ease-in-out infinite;
        }
        
        @keyframes splash-glow {
            0%, 100% { filter: drop-shadow(0 0 10px var(--gold-glow)); }
            50% { filter: drop-shadow(0 0 20px var(--gold-glow)); }
        }
        
        .splash-subtitle {
            font-family: var(--font-accent);
            font-style: italic;
            font-size: 1rem;
            color: var(--gold-dark);
            letter-spacing: 0.2em;
            margin-bottom: 48px;
        }
        
        .splash-progress {
            width: 200px;
            height: 4px;
            background: rgba(212, 168, 75, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin: 0 auto 16px;
        }
        
        .splash-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-main), var(--copper));
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .splash-status {
            font-size: 0.85rem;
            color: var(--text-dim);
            letter-spacing: 0.1em;
        }
        
        /* ============================================
           煉金術背景效果
           ============================================ */
        .alchemy-bg {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        
        .alchemy-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(ellipse at 15% 15%, rgba(212, 168, 75, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 85% 85%, rgba(184, 115, 51, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(45, 27, 78, 0.2) 0%, transparent 70%);
        }
        
        [data-theme="light"] .alchemy-bg::before {
            background: 
                radial-gradient(ellipse at 15% 15%, rgba(212, 168, 75, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 85% 85%, rgba(184, 115, 51, 0.08) 0%, transparent 50%);
        }
        
        .magic-circle {
            position: absolute;
            border: 1px solid var(--border-light);
            border-radius: 50%;
            animation: rotate-slow 60s linear infinite;
        }
        
        .magic-circle:nth-child(1) {
            width: 600px;
            height: 600px;
            top: -200px;
            left: -200px;
        }
        
        .magic-circle:nth-child(2) {
            width: 800px;
            height: 800px;
            bottom: -300px;
            right: -300px;
            animation-direction: reverse;
            animation-duration: 80s;
        }
        
        .magic-circle:nth-child(3) {
            width: 400px;
            height: 400px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-style: dashed;
        }
        
        @keyframes rotate-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--gold-main);
            border-radius: 50%;
            opacity: 0;
            animation: float-particle 10s ease-in-out infinite;
        }
        
        @keyframes float-particle {
            0%, 100% { opacity: 0; transform: translateY(100vh) scale(0); }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { opacity: 0; transform: translateY(-100px) scale(1); }
        }
        
        /* ============================================
           應用程式容器
           ============================================ */
        .app-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* ============================================
           頂部導覽列
           ============================================ */
        .app-header {
            height: var(--header-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            backdrop-filter: blur(10px);
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--gold-main), var(--copper));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            box-shadow: 0 0 15px var(--gold-glow);
        }
        
        .header-logo-text {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gold-main);
            letter-spacing: 0.08em;
        }
        
        .header-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.85rem;
            transition: all var(--transition-normal);
        }
        
        .nav-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .nav-btn.active {
            background: rgba(212, 168, 75, 0.1);
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .nav-btn-icon {
            font-size: 1.1rem;
        }
        
        .nav-divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 8px;
        }
        
        .theme-toggle {
            width: 40px;
            height: 40px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            color: var(--text-secondary);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
        }
        
        .theme-toggle:hover {
            background: var(--bg-tertiary);
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        /* ============================================
           主內容區
           ============================================ */
        .app-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* ============================================
           左側邊欄 - 輸入區
           ============================================ */
        .sidebar-left {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: all var(--transition-normal);
            overflow: hidden;
        }
        
        .sidebar-left.collapsed {
            width: 0;
            padding: 0;
            border: none;
        }
        
        .sidebar-right.collapsed {
            width: 0;
            padding: 0;
            border: none;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
        }
        
        .sidebar-title {
            font-family: var(--font-display);
            font-size: 0.9rem;
            color: var(--gold-main);
            letter-spacing: 0.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* ============================================
           API Key 區塊
           ============================================ */
        .api-block {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .api-block-title {
            font-size: 0.8rem;
            color: var(--text-dim);
            letter-spacing: 0.08em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .api-input-wrapper {
            position: relative;
        }
        
        .api-input {
            width: 100%;
            padding: 12px 40px 12px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all var(--transition-normal);
        }
        
        .api-input:focus {
            outline: none;
            border-color: var(--gold-main);
            box-shadow: 0 0 0 3px var(--gold-glow);
        }
        
        .api-input::placeholder {
            color: var(--text-dim);
        }
        
        .api-toggle-visibility {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: color var(--transition-fast);
        }
        
        .api-toggle-visibility:hover {
            color: var(--gold-main);
        }
        
        .api-verify-btn {
            width: 100%;
            padding: 10px 16px;
            margin-top: 10px;
            background: linear-gradient(135deg, var(--mystic-purple), var(--mystic-light));
            border: 1px solid var(--gold-dark);
            border-radius: var(--radius-md);
            color: var(--parchment);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .api-verify-btn:hover {
            background: linear-gradient(135deg, var(--mystic-light), var(--mystic-purple));
            border-color: var(--gold-main);
            box-shadow: 0 0 15px var(--gold-glow);
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        
        .api-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
            animation: blink 2s ease-in-out infinite;
        }
        
        .api-status-dot.connected {
            background: var(--success);
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .api-status-text {
            color: var(--text-dim);
        }
        
        .api-status-text.connected {
            color: var(--success);
        }
        
        /* ============================================
           上傳區塊
           ============================================ */
        .upload-block {
            margin-bottom: 20px;
        }
        
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 32px 20px;
            text-align: center;
            transition: all var(--transition-normal);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .upload-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--gold-glow) 0%, transparent 50%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--gold-main);
            background: rgba(212, 168, 75, 0.05);
        }
        
        .upload-zone:hover::before,
        .upload-zone.dragover::before {
            opacity: 0.3;
        }
        
        .upload-zone.dragover {
            transform: scale(1.02);
        }
        
        .upload-content {
            position: relative;
            z-index: 1;
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            display: block;
        }
        
        .upload-title {
            font-family: var(--font-display);
            font-size: 1rem;
            color: var(--gold-main);
            margin-bottom: 6px;
        }
        
        .upload-desc {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 12px;
        }
        
        .upload-formats {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .format-badge {
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            color: var(--text-dim);
            font-weight: 500;
        }
        
        .upload-input {
            display: none;
        }
        
        /* ============================================
           檔案列表
           ============================================ */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            transition: all var(--transition-normal);
        }
        
        .file-item:hover {
            border-color: var(--border-color);
        }
        
        .file-thumb {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .file-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-meta {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 2px;
        }
        
        .file-status {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            flex-shrink: 0;
        }
        
        .file-status.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        
        .file-status.processing {
            background: rgba(212, 168, 75, 0.15);
            color: var(--gold-main);
        }
        
        .file-status.done {
            background: rgba(74, 222, 128, 0.15);
            color: var(--success);
        }
        
        .file-status.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }
        
        .file-reset {
            width: 28px;
            height: 28px;
            background: transparent;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-sm);
            color: var(--info);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .file-reset:hover {
            background: var(--info);
            border-color: var(--info);
            color: white;
        }
        
        .file-remove {
            width: 28px;
            height: 28px;
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-sm);
            color: var(--error);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }
        
        .file-remove:hover {
            background: var(--error);
            border-color: var(--error);
            color: white;
        }
        
        /* ============================================
           設定區塊
           ============================================ */
        .settings-block {
            margin-bottom: 20px;
        }
        
        .settings-title {
            font-size: 0.8rem;
            color: var(--text-dim);
            letter-spacing: 0.08em;
            margin-bottom: 12px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 向量化風格 */
        .style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .style-btn {
            padding: 12px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all var(--transition-normal);
        }
        
        .style-btn:hover {
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .style-btn.active {
            background: rgba(212, 168, 75, 0.1);
            border-color: var(--gold-main);
            color: var(--gold-main);
            box-shadow: 0 0 15px var(--gold-glow);
        }
        
        .style-icon {
            font-size: 1.5rem;
        }
        
        /* 場景模板 */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .template-btn {
            padding: 10px 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all var(--transition-normal);
        }
        
        .template-btn:hover {
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .template-btn.active {
            background: rgba(212, 168, 75, 0.1);
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .template-icon {
            font-size: 1.2rem;
        }
        
        .custom-prompt-wrapper {
            margin-top: 12px;
        }
        
        .custom-prompt-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.85rem;
            resize: vertical;
            min-height: 80px;
            transition: border-color var(--transition-fast);
        }
        
        .custom-prompt-input:focus {
            outline: none;
            border-color: var(--gold-main);
        }
        
        .custom-prompt-input::placeholder {
            color: var(--text-dim);
        }
        
        /* ============================================
           進階設定
           ============================================ */
        .advanced-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            margin-bottom: 12px;
            transition: all var(--transition-normal);
        }
        
        .advanced-toggle:hover {
            border-color: var(--border-color);
        }
        
        .advanced-toggle-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .advanced-toggle-icon {
            font-size: 1rem;
            transition: transform var(--transition-normal);
        }
        
        .advanced-toggle.open .advanced-toggle-icon {
            transform: rotate(180deg);
        }
        
        .advanced-panel {
            display: none;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }
        
        .advanced-panel.show {
            display: block;
        }
        
        .advanced-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .advanced-row:last-child {
            margin-bottom: 0;
        }
        
        .advanced-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .advanced-input {
            width: 80px;
            padding: 6px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.8rem;
            text-align: center;
        }
        
        .advanced-input:focus {
            outline: none;
            border-color: var(--gold-main);
        }
        
        .advanced-select {
            padding: 6px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.8rem;
        }
        
        .advanced-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-input {
            width: 18px;
            height: 18px;
            accent-color: var(--gold-main);
        }
        
        /* ============================================
           轉換按鈕
           ============================================ */
        .convert-section {
            padding: 20px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-secondary);
        }
        
        .convert-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--gold-main), var(--copper));
            border: none;
            border-radius: var(--radius-md);
            color: var(--mystic-black);
            font-family: var(--font-display);
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .convert-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--gold-glow);
        }
        
        .convert-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .convert-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .convert-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .convert-btn:hover:not(:disabled)::before {
            left: 100%;
        }
        
        .convert-btn-icon {
            font-size: 1.2rem;
        }
        
        /* ============================================
           中央工作區
           ============================================ */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
        }
        
        .workspace-toolbar {
            height: var(--toolbar-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 8px;
        }
        
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 8px;
        }
        
        .toolbar-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .toolbar-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .toolbar-btn.active {
            background: rgba(212, 168, 75, 0.1);
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .toolbar-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .toolbar-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-left: 8px;
        }
        
        .toolbar-spacer {
            flex: 1;
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .zoom-value {
            font-size: 0.8rem;
            color: var(--text-secondary);
            min-width: 45px;
            text-align: center;
            font-family: var(--font-mono);
        }
        
        /* ============================================
           畫布區域
           ============================================ */
        .canvas-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: 
                repeating-linear-gradient(
                    0deg,
                    var(--border-light) 0px,
                    var(--border-light) 1px,
                    transparent 1px,
                    transparent 20px
                ),
                repeating-linear-gradient(
                    90deg,
                    var(--border-light) 0px,
                    var(--border-light) 1px,
                    transparent 1px,
                    transparent 20px
                );
        }
        
        .canvas-empty {
            text-align: center;
            color: var(--text-dim);
        }
        
        .canvas-empty-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .canvas-empty-title {
            font-family: var(--font-display);
            font-size: 1.2rem;
            color: var(--gold-main);
            margin-bottom: 8px;
        }
        
        .canvas-empty-desc {
            font-size: 0.9rem;
        }
        
        .canvas-viewport {
            position: absolute;
            inset: 0;
            overflow: auto;
        }
        
        .canvas-content {
            min-width: 100%;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        .svg-preview {
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            max-width: 100%;
            max-height: 100%;
        }
        
        /* ============================================
           右側邊欄 - 編輯區
           ============================================ */
        .sidebar-right {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: all var(--transition-normal);
            overflow: hidden;
        }
        
        .editor-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }
        
        .editor-tab {
            flex: 1;
            padding: 14px 12px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-dim);
            font-size: 0.8rem;
            font-weight: 500;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .editor-tab:hover {
            color: var(--text-secondary);
            background: var(--bg-tertiary);
        }
        
        .editor-tab.active {
            color: var(--gold-main);
            border-bottom-color: var(--gold-main);
        }
        
        .editor-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .editor-section {
            margin-bottom: 24px;
        }
        
        .editor-section-title {
            font-size: 0.75rem;
            color: var(--text-dim);
            letter-spacing: 0.08em;
            text-transform: uppercase;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 顏色編輯器 */
        .color-palette {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .color-swatch {
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
        }
        
        .color-swatch.selected {
            border-color: var(--gold-main);
            box-shadow: 0 0 10px var(--gold-glow);
        }
        
        .color-swatch.selected::after {
            content: '✓';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            font-size: 0.8rem;
        }
        
        .color-custom {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .color-picker-wrapper {
            position: relative;
            width: 40px;
            height: 40px;
        }
        
        .color-picker {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            padding: 0;
        }
        
        .color-hex-input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }
        
        .color-hex-input:focus {
            outline: none;
            border-color: var(--gold-main);
        }
        
        .apply-color-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--gold-main), var(--copper));
            border: none;
            border-radius: var(--radius-sm);
            color: var(--mystic-black);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .apply-color-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--gold-glow);
        }
        
        .apply-transform-btn {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--gold-main), var(--copper));
            border: none;
            border-radius: var(--radius-md);
            color: var(--mystic-black);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .apply-transform-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--gold-glow);
        }
        
        /* 圖層列表 */
        .layer-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .layer-item:hover {
            border-color: var(--border-color);
        }
        
        .layer-item.selected {
            border-color: var(--gold-main);
            background: rgba(212, 168, 75, 0.1);
        }
        
        .layer-visibility {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 1rem;
            cursor: pointer;
            transition: color var(--transition-fast);
        }
        
        .layer-visibility:hover {
            color: var(--gold-main);
        }
        
        .layer-visibility.hidden {
            opacity: 0.4;
        }
        
        .layer-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .layer-name {
            flex: 1;
            font-size: 0.8rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .layer-type {
            font-size: 0.7rem;
            color: var(--text-dim);
            padding: 2px 6px;
            background: var(--bg-primary);
            border-radius: var(--radius-xs);
        }
        
        /* 變換控制 */
        .transform-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .transform-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .transform-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .transform-input {
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }
        
        .transform-input:focus {
            outline: none;
            border-color: var(--gold-main);
        }
        
        /* 歷史記錄 */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .history-item:hover {
            background: rgba(212, 168, 75, 0.1);
        }
        
        .history-item.current {
            background: rgba(212, 168, 75, 0.15);
            color: var(--gold-main);
        }
        
        .history-item.future {
            opacity: 0.5;
        }
        
        .history-icon {
            font-size: 1rem;
        }
        
        .history-text {
            flex: 1;
        }
        
        .history-time {
            font-size: 0.7rem;
            color: var(--text-dim);
        }
        /* ============================================
           額外 CSS 動畫和效果
           ============================================ */
        
        /* 按鈕漣漪效果 */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, var(--gold-main) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform 0.5s, opacity 1s;
        }
        
        .ripple:active::after {
            transform: scale(0, 0);
            opacity: 0.3;
            transition: 0s;
        }
        
        /* 載入動畫變體 */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .shimmer {
            background: linear-gradient(
                90deg,
                var(--bg-tertiary) 25%,
                var(--border-color) 50%,
                var(--bg-tertiary) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .bounce {
            animation: bounce 1s ease-in-out infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-down {
            animation: fadeInDown 0.5s ease forwards;
        }
        
        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .fade-in-left {
            animation: fadeInLeft 0.5s ease forwards;
        }
        
        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .fade-in-right {
            animation: fadeInRight 0.5s ease forwards;
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .scale-in {
            animation: scaleIn 0.3s ease forwards;
        }
        
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-in-top {
            animation: slideInFromTop 0.4s ease forwards;
        }
        
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-in-bottom {
            animation: slideInFromBottom 0.4s ease forwards;
        }
        
        /* 浮動標籤 */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .float {
            animation: float 3s ease-in-out infinite;
        }
        
        /* 心跳效果 */
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            14% { transform: scale(1.1); }
            28% { transform: scale(1); }
            42% { transform: scale(1.1); }
            70% { transform: scale(1); }
        }
        
        .heartbeat {
            animation: heartbeat 1.5s ease-in-out infinite;
        }
        
        /* 打字機效果 */
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
        
        .typing {
            overflow: hidden;
            white-space: nowrap;
            animation: typing 2s steps(30, end);
        }
        
        /* 閃爍游標 */
        @keyframes blink-caret {
            50% { border-color: transparent; }
        }
        
        .typing-cursor {
            border-right: 2px solid var(--gold-main);
            animation: blink-caret 0.75s step-end infinite;
        }
        
        /* 霓虹發光 */
        @keyframes neon-glow {
            0%, 100% {
                text-shadow: 
                    0 0 5px var(--gold-main),
                    0 0 10px var(--gold-main),
                    0 0 20px var(--gold-main);
            }
            50% {
                text-shadow: 
                    0 0 10px var(--gold-bright),
                    0 0 20px var(--gold-bright),
                    0 0 40px var(--gold-bright),
                    0 0 80px var(--gold-bright);
            }
        }
        
        .neon-glow {
            animation: neon-glow 2s ease-in-out infinite;
        }
        
        /* 背景漸變動畫 */
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-animated {
            background-size: 200% 200%;
            animation: gradient-shift 5s ease infinite;
        }
        
        /* 旋轉光暈 */
        @keyframes halo-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .halo {
            position: relative;
        }
        
        .halo::before {
            content: '';
            position: absolute;
            inset: -5px;
            border-radius: inherit;
            background: conic-gradient(
                from 0deg,
                var(--gold-main),
                var(--copper),
                var(--gold-bright),
                var(--gold-main)
            );
            opacity: 0.5;
            z-index: -1;
            animation: halo-rotate 3s linear infinite;
        }
        
        /* 波紋擴散 */
        @keyframes ripple-expand {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .ripple-effect {
            position: absolute;
            border-radius: 50%;
            background: var(--gold-glow);
            animation: ripple-expand 1s ease-out;
        }
        
        /* ============================================
           工具提示
           ============================================ */
        .tooltip {
            position: relative;
        }
        
        .tooltip::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            color: var(--text-primary);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-fast);
            z-index: 100;
            box-shadow: var(--shadow-md);
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            border: 6px solid transparent;
            border-top-color: var(--bg-secondary);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-fast);
        }
        
        .tooltip:hover::before,
        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        /* ============================================
           下拉選單
           ============================================ */
        .dropdown {
            position: relative;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 180px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-normal);
            z-index: var(--z-dropdown);
        }
        
        .dropdown.open .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(8px);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .dropdown-item:first-child {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }
        
        .dropdown-item:last-child {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }
        
        .dropdown-item:hover {
            background: var(--bg-tertiary);
            color: var(--gold-main);
        }
        
        .dropdown-divider {
            height: 1px;
            background: var(--border-light);
            margin: 4px 0;
        }
        
        /* ============================================
           標籤 / 徽章
           ============================================ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: var(--radius-full);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .badge-primary {
            background: var(--gold-main);
            color: var(--mystic-black);
        }
        
        .badge-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        
        .badge-success {
            background: rgba(74, 222, 128, 0.15);
            color: var(--success);
        }
        
        .badge-error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        
        .badge-info {
            background: rgba(59, 130, 246, 0.15);
            color: var(--info);
        }
        
        /* 帶數字的徽章 */
        .badge-count {
            position: absolute;
            top: -6px;
            right: -6px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: var(--error);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ============================================
           卡片樣式
           ============================================ */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all var(--transition-normal);
        }
        
        .card:hover {
            border-color: var(--gold-main);
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-light);
        }
        
        .card-title {
            font-family: var(--font-display);
            font-size: 1rem;
            color: var(--gold-main);
        }
        
        .card-body {
            padding: 20px;
        }
        
        .card-footer {
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-light);
        }
        
        /* ============================================
           表單元素增強
           ============================================ */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .form-hint {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 6px;
        }
        
        .form-error {
            font-size: 0.75rem;
            color: var(--error);
            margin-top: 6px;
        }
        
        .input-group {
            display: flex;
            align-items: stretch;
        }
        
        .input-group .form-input {
            border-radius: var(--radius-md) 0 0 var(--radius-md);
        }
        
        .input-group-append {
            padding: 0 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-left: none;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-dim);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all var(--transition-normal);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--gold-main);
            box-shadow: 0 0 0 3px var(--gold-glow);
        }
        
        .form-input.error {
            border-color: var(--error);
        }
        
        .form-input.success {
            border-color: var(--success);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b7355' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        /* ============================================
           Range Slider
           ============================================ */
        .range-slider {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--gold-main);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--gold-glow);
            transition: all var(--transition-fast);
        }
        
        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .range-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--gold-main);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--gold-glow);
        }
        
        /* ============================================
           分隔線
           ============================================ */
        .divider {
            height: 1px;
            background: var(--border-color);
            margin: 24px 0;
        }
        
        .divider-text {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 24px 0;
            color: var(--text-dim);
            font-size: 0.8rem;
        }
        
        .divider-text::before,
        .divider-text::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }
        
        /* ============================================
           空狀態
           ============================================ */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-family: var(--font-display);
            font-size: 1.2rem;
            color: var(--gold-main);
            margin-bottom: 8px;
        }
        
        .empty-state-desc {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-bottom: 24px;
        }
        
        .empty-state-action {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--gold-main);
            border: none;
            border-radius: var(--radius-md);
            color: var(--mystic-black);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
        }
        
        .empty-state-action:hover {
            background: var(--gold-bright);
            transform: translateY(-2px);
        }
        
        /* ============================================
           骨架屏
           ============================================ */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--bg-tertiary) 0%,
                var(--border-color) 50%,
                var(--bg-tertiary) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }
        
        .skeleton-text:last-child {
            width: 60%;
        }
        
        .skeleton-circle {
            border-radius: 50%;
        }
        
        .skeleton-rect {
            border-radius: var(--radius-md);
        }
        
        /* ============================================
           圖片裝載器
           ============================================ */
        .image-loader {
            position: relative;
            overflow: hidden;
        }
        
        .image-loader img {
            transition: opacity var(--transition-normal);
        }
        
        .image-loader.loading img {
            opacity: 0;
        }
        
        .image-loader.loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--bg-tertiary);
            animation: shimmer 1.5s infinite;
        }
        
        /* ============================================
           拖放指示器
           ============================================ */
        .drop-indicator {
            position: fixed;
            inset: 0;
            background: rgba(212, 168, 75, 0.1);
            border: 3px dashed var(--gold-main);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        .drop-indicator.show {
            display: flex;
        }
        
        .drop-indicator-content {
            text-align: center;
            padding: 48px;
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
        }
        
        .drop-indicator-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }
        
        .drop-indicator-text {
            font-family: var(--font-display);
            font-size: 1.2rem;
            color: var(--gold-main);
        }
        
        /* ============================================
           確認對話框
           ============================================ */
        .confirm-dialog {
            position: fixed;
            inset: 0;
            background: rgba(13, 7, 21, 0.95);
            z-index: calc(var(--z-modal) + 10);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        
        .confirm-dialog.show {
            display: flex;
        }
        
        .confirm-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 400px;
            text-align: center;
        }
        
        .confirm-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }
        
        .confirm-title {
            font-family: var(--font-display);
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .confirm-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        
        .confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .confirm-btn {
            padding: 10px 24px;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
        }
        
        .confirm-btn-cancel {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        
        .confirm-btn-cancel:hover {
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .confirm-btn-confirm {
            background: var(--gold-main);
            border: none;
            color: var(--mystic-black);
        }
        
        .confirm-btn-confirm:hover {
            background: var(--gold-bright);
        }
        
        .confirm-btn-danger {
            background: var(--error);
            border: none;
            color: white;
        }
        
        .confirm-btn-danger:hover {
            background: var(--error-dark);
        }
        /* ============================================
           更多響應式優化
           ============================================ */
        
        /* 高解析度螢幕 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .magic-circle {
                border-width: 0.5px;
            }
            
            .particle {
                width: 3px;
                height: 3px;
            }
        }
        
        /* 大螢幕優化 (1920px+) */
        @media (min-width: 1920px) {
            :root {
                --sidebar-width: 360px;
            }
            
            .app-container {
                max-width: 1800px;
                margin: 0 auto;
            }
            
            .upload-zone {
                padding: 48px 32px;
            }
            
            .output-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* 超寬螢幕 (2560px+) */
        @media (min-width: 2560px) {
            :root {
                --sidebar-width: 400px;
                font-size: 18px;
            }
            
            .output-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* 列印樣式 */
        @media print {
            .app-header,
            .sidebar-left,
            .sidebar-right,
            .workspace-toolbar,
            .alchemy-bg,
            .toast-container {
                display: none !important;
            }
            
            .workspace {
                width: 100%;
                padding: 0;
            }
            
            .canvas-container {
                background: white;
            }
            
            .svg-preview {
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }
        
        /* 強制色彩模式（高對比） */
        @media (forced-colors: active) {
            .convert-btn,
            .batch-btn.primary,
            .preview-btn.primary {
                border: 2px solid currentColor;
            }
            
            .color-swatch {
                border: 2px solid currentColor;
            }
        }
        
        /* 偏好暗色模式 */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                color-scheme: dark;
            }
        }
        
        /* 偏好亮色模式 */
        @media (prefers-color-scheme: light) {
            :root:not([data-theme="dark"]) {
                --bg-primary: #f8f5f0;
                --bg-secondary: #ffffff;
                --text-primary: #2c2416;
            }
        }
        
        /* ============================================
           額外動畫效果
           ============================================ */
        
        /* 3D 翻轉卡片 */
        .flip-card {
            perspective: 1000px;
        }
        
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .flip-card:hover .flip-card-inner {
            transform: rotateY(180deg);
        }
        
        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
        }
        
        .flip-card-back {
            transform: rotateY(180deg);
        }
        
        /* 閃光效果 */
        @keyframes flash {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0; }
        }
        
        .flash {
            animation: flash 0.5s ease;
        }
        
        /* 搖擺效果 */
        @keyframes swing {
            20% { transform: rotate(15deg); }
            40% { transform: rotate(-10deg); }
            60% { transform: rotate(5deg); }
            80% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }
        
        .swing {
            animation: swing 1s ease;
            transform-origin: top center;
        }
        
        /* 橡皮筋效果 */
        @keyframes rubber-band {
            0% { transform: scale(1); }
            30% { transform: scaleX(1.25) scaleY(0.75); }
            40% { transform: scaleX(0.75) scaleY(1.25); }
            50% { transform: scaleX(1.15) scaleY(0.85); }
            65% { transform: scaleX(0.95) scaleY(1.05); }
            75% { transform: scaleX(1.05) scaleY(0.95); }
            100% { transform: scale(1); }
        }
        
        .rubber-band {
            animation: rubber-band 1s ease;
        }
        
        /* 果凍效果 */
        @keyframes jello {
            0%, 100% { transform: none; }
            11.1% { transform: skewX(-12.5deg) skewY(-12.5deg); }
            22.2% { transform: skewX(6.25deg) skewY(6.25deg); }
            33.3% { transform: skewX(-3.125deg) skewY(-3.125deg); }
            44.4% { transform: skewX(1.5625deg) skewY(1.5625deg); }
            55.5% { transform: skewX(-0.78125deg) skewY(-0.78125deg); }
            66.6% { transform: skewX(0.390625deg) skewY(0.390625deg); }
            77.7% { transform: skewX(-0.1953125deg) skewY(-0.1953125deg); }
        }
        
        .jello {
            animation: jello 1s ease;
            transform-origin: center;
        }
        
        /* 心跳效果增強版 */
        @keyframes heartbeat-strong {
            0% { transform: scale(1); }
            14% { transform: scale(1.3); }
            28% { transform: scale(1); }
            42% { transform: scale(1.3); }
            70% { transform: scale(1); }
        }
        
        .heartbeat-strong {
            animation: heartbeat-strong 1.3s ease-in-out infinite;
        }
        
        /* 脈衝環 */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        .pulse-ring::before {
            content: '';
            position: absolute;
            inset: -10px;
            border: 2px solid var(--gold-main);
            border-radius: 50%;
            animation: pulse-ring 1.5s ease-out infinite;
        }
        
        /* 打字機游標 */
        @keyframes cursor-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        .cursor-blink::after {
            content: '|';
            animation: cursor-blink 1s step-end infinite;
            color: var(--gold-main);
        }
        
        /* 漂浮粒子增強 */
        @keyframes particle-float {
            0%, 100% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% {
                transform: translateY(-100vh) translateX(50px) rotate(360deg);
                opacity: 0;
            }
        }
        
        .particle-enhanced {
            animation: particle-float 15s ease-in-out infinite;
        }
        
        /* 波浪效果 */
        @keyframes wave {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-5px); }
            50% { transform: translateY(0); }
            75% { transform: translateY(5px); }
        }
        
        .wave {
            animation: wave 2s ease-in-out infinite;
        }
        
        .wave-container > * {
            animation: wave 2s ease-in-out infinite;
        }
        
        .wave-container > *:nth-child(1) { animation-delay: 0s; }
        .wave-container > *:nth-child(2) { animation-delay: 0.1s; }
        .wave-container > *:nth-child(3) { animation-delay: 0.2s; }
        .wave-container > *:nth-child(4) { animation-delay: 0.3s; }
        .wave-container > *:nth-child(5) { animation-delay: 0.4s; }
        
        /* 滑入動畫系列 */
        @keyframes slide-in-blur-left {
            0% {
                transform: translateX(-100px) scaleX(2.5) scaleY(0.2);
                filter: blur(40px);
                opacity: 0;
            }
            100% {
                transform: translateX(0) scaleY(1) scaleX(1);
                filter: blur(0);
                opacity: 1;
            }
        }
        
        .slide-in-blur-left {
            animation: slide-in-blur-left 0.6s cubic-bezier(0.230, 1.000, 0.320, 1.000) both;
        }
        
        @keyframes slide-in-blur-right {
            0% {
                transform: translateX(100px) scaleX(2.5) scaleY(0.2);
                filter: blur(40px);
                opacity: 0;
            }
            100% {
                transform: translateX(0) scaleY(1) scaleX(1);
                filter: blur(0);
                opacity: 1;
            }
        }
        
        .slide-in-blur-right {
            animation: slide-in-blur-right 0.6s cubic-bezier(0.230, 1.000, 0.320, 1.000) both;
        }
        
        /* 文字漸顯 */
        @keyframes text-focus-in {
            0% {
                filter: blur(12px);
                opacity: 0;
            }
            100% {
                filter: blur(0px);
                opacity: 1;
            }
        }
        
        .text-focus-in {
            animation: text-focus-in 1s cubic-bezier(0.550, 0.085, 0.680, 0.530) both;
        }
        
        /* 光環旋轉 */
        @keyframes rotate-center {
            0% { transform: rotate(0); }
            100% { transform: rotate(360deg); }
        }
        
        .rotate-center {
            animation: rotate-center 8s linear infinite;
        }
        
        /* 懸浮陰影 */
        @keyframes hover-shadow {
            0%, 100% {
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                transform: translateY(0);
            }
            50% {
                box-shadow: 0 25px 35px rgba(0, 0, 0, 0.2);
                transform: translateY(-10px);
            }
        }
        
        .hover-shadow {
            animation: hover-shadow 3s ease-in-out infinite;
        }
        
        /* 文字陰影脈衝 */
        @keyframes text-shadow-pulse {
            0%, 100% {
                text-shadow: 0 0 4px var(--gold-glow);
            }
            50% {
                text-shadow: 0 0 20px var(--gold-main), 0 0 40px var(--gold-glow);
            }
        }
        
        .text-shadow-pulse {
            animation: text-shadow-pulse 2s ease-in-out infinite;
        }
        
        /* 邊框動畫 */
        @keyframes border-dance {
            0%, 100% {
                border-color: var(--gold-main);
            }
            25% {
                border-color: var(--copper);
            }
            50% {
                border-color: var(--gold-bright);
            }
            75% {
                border-color: var(--copper-light);
            }
        }
        
        .border-dance {
            animation: border-dance 4s ease-in-out infinite;
        }
        
        /* 漸層背景動畫 */
        @keyframes gradient-x {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .gradient-x {
            background: linear-gradient(90deg, var(--gold-main), var(--copper), var(--gold-bright), var(--gold-main));
            background-size: 300% 100%;
            animation: gradient-x 5s ease infinite;
        }
        
        @keyframes gradient-y {
            0%, 100% { background-position: 50% 0%; }
            50% { background-position: 50% 100%; }
        }
        
        .gradient-y {
            background: linear-gradient(180deg, var(--gold-main), var(--copper), var(--gold-bright), var(--gold-main));
            background-size: 100% 300%;
            animation: gradient-y 5s ease infinite;
        }
        
        /* 閃爍星星 */
        @keyframes twinkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }
        
        .twinkle {
            animation: twinkle 2s ease-in-out infinite;
        }
        
        .twinkle:nth-child(2n) {
            animation-delay: 0.5s;
        }
        
        .twinkle:nth-child(3n) {
            animation-delay: 1s;
        }
        
        /* 膨脹收縮 */
        @keyframes inflate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .inflate {
            animation: inflate 2s ease-in-out infinite;
        }
        
        /* 搖頭效果 */
        @keyframes head-shake {
            0% { transform: translateX(0); }
            6.5% { transform: translateX(-6px) rotateY(-9deg); }
            18.5% { transform: translateX(5px) rotateY(7deg); }
            31.5% { transform: translateX(-3px) rotateY(-5deg); }
            43.5% { transform: translateX(2px) rotateY(3deg); }
            50% { transform: translateX(0); }
        }
        
        .head-shake {
            animation: head-shake 1s ease-in-out;
        }
        
        /* 成功打勾 */
        @keyframes check-mark {
            0% { stroke-dashoffset: 100; }
            100% { stroke-dashoffset: 0; }
        }
        
        .check-mark {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: check-mark 0.5s ease forwards;
        }
        
        /* 載入點點 */
        @keyframes loading-dots {
            0%, 80%, 100% { transform: scale(0); opacity: 0; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .loading-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 0 4px;
            background: var(--gold-main);
            border-radius: 50%;
            animation: loading-dots 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        .loading-dots span:nth-child(3) { animation-delay: 0s; }
        /* ============================================
           輸出面板
           ============================================ */
        .output-panel {
            padding: 20px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-secondary);
        }
        
        .output-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .output-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            transition: all var(--transition-normal);
        }
        
        .output-item:hover {
            border-color: var(--gold-main);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .output-item.selected {
            border-color: var(--gold-main);
            box-shadow: 0 0 15px var(--gold-glow);
        }
        
        .output-preview {
            aspect-ratio: 1;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }
        
        .output-preview svg,
        .output-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .output-info {
            padding: 10px;
        }
        
        .output-name {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 6px;
        }
        
        .output-actions {
            display: flex;
            gap: 6px;
        }
        
        .output-btn {
            flex: 1;
            padding: 6px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.65rem;
            font-weight: 500;
            transition: all var(--transition-fast);
        }
        
        .output-btn:hover {
            background: var(--gold-main);
            border-color: var(--gold-main);
            color: var(--mystic-black);
        }
        
        /* 批次操作 */
        .batch-actions {
            display: flex;
            gap: 8px;
        }
        
        .batch-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all var(--transition-normal);
        }
        
        .batch-btn:hover {
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .batch-btn.primary {
            background: var(--gold-main);
            border-color: var(--gold-main);
            color: var(--mystic-black);
        }
        
        .batch-btn.primary:hover {
            background: var(--gold-bright);
        }
        
        /* ============================================
           進度 Overlay
           ============================================ */
        .progress-overlay {
            position: fixed;
            inset: 0;
            background: rgba(13, 7, 21, 0.95);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        .progress-overlay.show {
            display: flex;
        }
        
        .progress-content {
            text-align: center;
            padding: 48px;
            max-width: 400px;
        }
        
        .progress-alchemy {
            width: 140px;
            height: 140px;
            margin: 0 auto 36px;
            position: relative;
        }
        
        .progress-circle {
            position: absolute;
            inset: 0;
            border: 3px solid var(--border-light);
            border-top-color: var(--gold-main);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .progress-circle:nth-child(2) {
            inset: 18px;
            animation-direction: reverse;
            animation-duration: 1.5s;
            border-top-color: var(--copper);
        }
        
        .progress-circle:nth-child(3) {
            inset: 36px;
            animation-duration: 2s;
            border-top-color: var(--gold-bright);
        }
        
        .progress-symbol {
            position: absolute;
            inset: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.8; }
        }
        
        .progress-title {
            font-family: var(--font-display);
            font-size: 1.4rem;
            color: var(--gold-main);
            margin-bottom: 12px;
            letter-spacing: 0.1em;
        }
        
        .progress-step {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-bottom: 24px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: var(--border-light);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-main), var(--copper), var(--gold-bright));
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-percent {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--gold-main);
        }
        
        .progress-cancel {
            margin-top: 24px;
            padding: 10px 24px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-dim);
            font-size: 0.85rem;
            transition: all var(--transition-normal);
        }
        
        .progress-cancel:hover {
            border-color: var(--error);
            color: var(--error);
        }
        
        /* ============================================
           預覽 Modal
           ============================================ */
        .preview-modal {
            position: fixed;
            inset: 0;
            background: rgba(13, 7, 21, 0.95);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
        }
        
        .preview-modal.show {
            display: flex;
        }
        
        .preview-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
        }
        
        .preview-header {
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .preview-title {
            font-family: var(--font-display);
            font-size: 1rem;
            color: var(--gold-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preview-close {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            color: var(--text-secondary);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .preview-close:hover {
            background: var(--error);
            border-color: var(--error);
            color: white;
        }
        
        .preview-body {
            flex: 1;
            overflow: auto;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            padding: 32px;
        }
        
        .preview-body svg {
            max-width: 100%;
            max-height: 70vh;
        }
        
        .preview-footer {
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        .preview-btn {
            padding: 10px 18px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-normal);
        }
        
        .preview-btn:hover {
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .preview-btn.primary {
            background: var(--gold-main);
            border-color: var(--gold-main);
            color: var(--mystic-black);
        }
        
        .preview-btn.primary:hover {
            background: var(--gold-bright);
        }
        
        /* ============================================
           導出 Modal
           ============================================ */
        .export-modal {
            position: fixed;
            inset: 0;
            background: rgba(13, 7, 21, 0.95);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        
        .export-modal.show {
            display: flex;
        }
        
        .export-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
        }
        
        .export-header {
            padding: 20px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .export-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--gold-main);
        }
        
        .export-body {
            padding: 24px;
        }
        
        .export-section {
            margin-bottom: 24px;
        }
        
        .export-section:last-child {
            margin-bottom: 0;
        }
        
        .export-section-title {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        .export-format-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .export-format-btn {
            padding: 16px 12px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-normal);
        }
        
        .export-format-btn:hover {
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .export-format-btn.selected {
            background: rgba(212, 168, 75, 0.1);
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .export-format-icon {
            font-size: 1.8rem;
        }
        
        .export-size-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .export-size-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .export-size-label {
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        
        .export-size-input {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .export-preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .export-preset-btn {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-align: left;
            transition: all var(--transition-fast);
        }
        
        .export-preset-btn:hover {
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .export-preset-name {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .export-preset-size {
            font-size: 0.7rem;
            color: var(--text-dim);
        }
        
        .export-footer {
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        /* ============================================
           設定 Modal
           ============================================ */
        .settings-modal {
            position: fixed;
            inset: 0;
            background: rgba(13, 7, 21, 0.95);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        
        .settings-modal.show {
            display: flex;
        }
        
        .settings-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .settings-header {
            padding: 20px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .settings-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--gold-main);
        }
        
        .settings-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .settings-group {
            margin-bottom: 32px;
        }
        
        .settings-group:last-child {
            margin-bottom: 0;
        }
        
        .settings-group-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }
        
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .settings-row:last-child {
            border-bottom: none;
        }
        
        .settings-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .settings-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 4px;
        }
        
        .settings-control {
            flex-shrink: 0;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            cursor: pointer;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            inset: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 13px;
            transition: all var(--transition-normal);
        }
        
        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            left: 2px;
            top: 2px;
            background: var(--text-dim);
            border-radius: 50%;
            transition: all var(--transition-normal);
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background: var(--gold-main);
            border-color: var(--gold-main);
        }
        
        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(22px);
            background: var(--mystic-black);
        }
        
        /* ============================================
           教學導覽
           ============================================ */
        .tutorial-overlay {
            position: fixed;
            inset: 0;
            background: rgba(13, 7, 21, 0.9);
            z-index: calc(var(--z-modal) + 100);
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .tutorial-overlay.show {
            display: flex;
        }
        
        .tutorial-spotlight {
            position: absolute;
            border: 3px solid var(--gold-main);
            border-radius: var(--radius-lg);
            box-shadow: 0 0 0 9999px rgba(13, 7, 21, 0.9), 0 0 30px var(--gold-glow);
            transition: all var(--transition-normal);
        }
        
        .tutorial-popup {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--gold-main);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 350px;
            box-shadow: var(--shadow-xl), 0 0 30px var(--gold-glow);
        }
        
        .tutorial-step {
            font-size: 0.75rem;
            color: var(--gold-main);
            margin-bottom: 8px;
            letter-spacing: 0.1em;
        }
        
        .tutorial-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .tutorial-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .tutorial-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .tutorial-btn {
            padding: 10px 18px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.85rem;
            transition: all var(--transition-normal);
        }
        
        .tutorial-btn:hover {
            border-color: var(--gold-main);
            color: var(--gold-main);
        }
        
        .tutorial-btn.primary {
            background: var(--gold-main);
            border-color: var(--gold-main);
            color: var(--mystic-black);
        }
        
        .tutorial-btn.primary:hover {
            background: var(--gold-bright);
        }
        
        .tutorial-progress {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            justify-content: center;
        }
        
        .tutorial-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-color);
            transition: all var(--transition-fast);
        }
        
        .tutorial-dot.active {
            background: var(--gold-main);
            transform: scale(1.2);
        }
        
        .tutorial-dot.completed {
            background: var(--success);
        }
        
        /* ============================================
           Toast 通知
           ============================================ */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }
        
        .toast {
            padding: 14px 18px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            animation: toast-slide-in 0.3s ease;
            pointer-events: auto;
        }
        
        .toast.hiding {
            animation: toast-slide-out 0.3s ease forwards;
        }
        
        @keyframes toast-slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes toast-slide-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--error); }
        .toast.warning { border-color: var(--warning); }
        .toast.info { border-color: var(--info); }
        
        .toast-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        
        .toast.success .toast-icon { color: var(--success); }
        .toast.error .toast-icon { color: var(--error); }
        .toast.warning .toast-icon { color: var(--warning); }
        .toast.info .toast-icon { color: var(--info); }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .toast-close {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 1rem;
            cursor: pointer;
            flex-shrink: 0;
            transition: color var(--transition-fast);
        }
        
        .toast-close:hover {
            color: var(--text-primary);
        }
        
        /* ============================================
           快捷鍵提示
           ============================================ */
        .shortcuts-modal {
            position: fixed;
            inset: 0;
            background: rgba(13, 7, 21, 0.95);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        
        .shortcuts-modal.show {
            display: flex;
        }
        
        .shortcuts-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }
        
        .shortcuts-header {
            padding: 20px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .shortcuts-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--gold-main);
        }
        
        .shortcuts-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .shortcuts-group {
            margin-bottom: 24px;
        }
        
        .shortcuts-group:last-child {
            margin-bottom: 0;
        }
        
        .shortcuts-group-title {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        .shortcut-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .shortcut-item:last-child {
            border-bottom: none;
        }
        
        .shortcut-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .shortcut-keys {
            display: flex;
            gap: 6px;
        }
        
        .key {
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--gold-main);
            min-width: 28px;
            text-align: center;
        }
        
        /* ============================================
           滾動條
           ============================================ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--gold-dark);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--gold-main);
        }
        
        /* ============================================
           響應式設計 - iPad Pro / 大螢幕
           ============================================ */
        @media (max-width: 1400px) {
            :root {
                --sidebar-width: 300px;
            }
        }
        
        /* iPad 橫向 / 小筆電 */
        @media (max-width: 1200px) {
            :root {
                --sidebar-width: 280px;
            }
            
            .header-logo-text {
                display: none;
            }
            
            .nav-btn span:not(.nav-btn-icon) {
                display: none;
            }
        }
        
        /* iPad / 平板 */
        @media (max-width: 1024px) {
            .sidebar-right {
                position: fixed;
                right: 0;
                top: var(--header-height);
                bottom: 0;
                transform: translateX(100%);
                z-index: var(--z-dropdown);
                box-shadow: var(--shadow-xl);
            }
            
            .sidebar-right.open {
                transform: translateX(0);
            }
            
            .sidebar-overlay {
                position: fixed;
                inset: 0;
                top: var(--header-height);
                background: rgba(0,0,0,0.5);
                z-index: calc(var(--z-dropdown) - 1);
                display: none;
            }
            
            .sidebar-overlay.show {
                display: block;
            }
        }
        
        /* 手機橫向 / 小平板 */
        @media (max-width: 768px) {
            :root {
                --header-height: 56px;
                --sidebar-width: 100%;
            }
            
            .app-header {
                padding: 0 16px;
            }
            
            .header-logo-icon {
                width: 36px;
                height: 36px;
                font-size: 1.1rem;
            }
            
            .nav-btn {
                padding: 8px 12px;
            }
            
            .nav-divider {
                display: none;
            }
            
            .sidebar-left {
                position: fixed;
                left: 0;
                top: var(--header-height);
                bottom: 0;
                width: 100%;
                max-width: 320px;
                transform: translateX(-100%);
                z-index: var(--z-dropdown);
                box-shadow: var(--shadow-xl);
            }
            
            .sidebar-left.open {
                transform: translateX(0);
            }
            
            .sidebar-right {
                width: 100%;
                max-width: 320px;
            }
            
            .workspace-toolbar {
                padding: 0 12px;
                overflow-x: auto;
            }
            
            .toolbar-btn {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
            
            .toast-container {
                left: 16px;
                right: 16px;
                bottom: 16px;
            }
            
            .toast {
                min-width: auto;
            }
            
            .preview-container,
            .export-container,
            .settings-container,
            .shortcuts-container {
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
            }
        }
        
        /* 手機直向 */
        @media (max-width: 480px) {
            .app-header {
                padding: 0 12px;
            }
            
            .splash-title {
                font-size: 1.5rem;
            }
            
            .splash-logo {
                width: 100px;
                height: 100px;
            }
            
            .splash-logo-inner {
                font-size: 2.8rem;
            }
            
            .upload-zone {
                padding: 24px 16px;
            }
            
            .upload-icon {
                font-size: 2.5rem;
            }
            
            .style-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .template-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .export-format-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .preview-footer {
                flex-direction: column;
            }
            
            .preview-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* 超小螢幕 */
        @media (max-width: 360px) {
            .sidebar-left {
                max-width: 100%;
            }
            
            .sidebar-right {
                max-width: 100%;
            }
            
            .template-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* 觸控裝置 */
        @media (hover: none) and (pointer: coarse) {
            .upload-zone:hover {
                transform: none;
            }
            
            .output-item:hover {
                transform: none;
            }
            
            .convert-btn:hover:not(:disabled) {
                transform: none;
            }
            
            .toolbar-btn,
            .nav-btn,
            .file-remove,
            .style-btn,
            .template-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* 減少動畫 */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- 啟動畫面 -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-bg">
            <div class="splash-circle"></div>
            <div class="splash-circle"></div>
            <div class="splash-circle"></div>
            <div class="splash-circle"></div>
        </div>
        <div class="splash-content">
            <div class="splash-logo">
                <div class="splash-logo-inner">⚗️</div>
                <div class="splash-ring"></div>
            </div>
            <div class="splash-title">向量化煉金工坊</div>
            <div class="splash-subtitle">Vector Alchemy Workshop</div>
            <div class="splash-progress">
                <div class="splash-progress-bar" id="splashProgress"></div>
            </div>
            <div class="splash-status" id="splashStatus">載入核心模組...</div>
        </div>
    </div>
    
    <!-- 背景效果 -->
    <div class="alchemy-bg" id="alchemyBg">
        <div class="magic-circle"></div>
        <div class="magic-circle"></div>
        <div class="magic-circle"></div>
    </div>
    
    <!-- 應用程式容器 -->
    <div class="app-container">
        <!-- 頂部導覽列 -->
        <header class="app-header">
            <div class="header-logo">
                <div class="header-logo-icon">⚗️</div>
                <span class="header-logo-text">向量化煉金工坊</span>
            </div>
            
            <nav class="header-nav">
                <button class="nav-btn" id="toggleLeftSidebar" title="輸入面板">
                    <span class="nav-btn-icon">📥</span>
                    <span>輸入</span>
                </button>
                <button class="nav-btn" id="toggleRightSidebar" title="編輯面板">
                    <span class="nav-btn-icon">✏️</span>
                    <span>編輯</span>
                </button>
                
                <div class="nav-divider"></div>
                
                <button class="nav-btn" id="tutorialBtn" title="使用教學">
                    <span class="nav-btn-icon">📖</span>
                    <span>教學</span>
                </button>
                <button class="nav-btn" id="shortcutsBtn" title="快捷鍵">
                    <span class="nav-btn-icon">⌨️</span>
                    <span>快捷鍵</span>
                </button>
                <button class="nav-btn" id="settingsBtn" title="設定">
                    <span class="nav-btn-icon">⚙️</span>
                    <span>設定</span>
                </button>
                
                <div class="nav-divider"></div>
                
                <button class="theme-toggle" id="themeToggle" title="切換主題">
                    🌙
                </button>
            </nav>
        </header>
        
        <!-- 主內容區 -->
        <main class="app-main">
            <!-- 側邊欄遮罩 -->
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            
            <!-- 左側邊欄 - 輸入區 -->
            <aside class="sidebar-left" id="sidebarLeft">
                <div class="sidebar-header">
                    <div class="sidebar-title">
                        <span>📥</span>
                        <span>原料投入</span>
                    </div>
                </div>
                
                <div class="sidebar-body">
                    <!-- API Key -->
                    <div class="api-block">
                        <div class="api-block-title">
                            <span>🔑</span>
                            <span>GEMINI API KEY</span>
                        </div>
                        <div class="api-input-wrapper">
                            <input type="password" class="api-input" id="apiKeyInput" placeholder="輸入您的 API Key...">
                            <button class="api-toggle-visibility" id="apiToggleVisibility" title="顯示/隱藏">👁️</button>
                        </div>
                        <button class="api-verify-btn" id="apiVerifyBtn">🔍 驗證金鑰</button>
                        <div class="api-status">
                            <span class="api-status-dot" id="apiStatusDot"></span>
                            <span class="api-status-text" id="apiStatusText">尚未連接</span>
                        </div>
                    </div>
                    
                    <!-- 上傳區 -->
                    <div class="upload-block">
                        <div class="upload-zone" id="uploadZone">
                            <div class="upload-content">
                                <span class="upload-icon">📜</span>
                                <div class="upload-title">拖放檔案至此</div>
                                <div class="upload-desc">或點擊選擇檔案</div>
                                <div class="upload-formats">
                                    <span class="format-badge">PDF</span>
                                    <span class="format-badge">JPG</span>
                                    <span class="format-badge">PNG</span>
                                    <span class="format-badge">WEBP</span>
                                    <span class="format-badge">GIF</span>
                                </div>
                            </div>
                            <input type="file" class="upload-input" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.webp,.gif">
                        </div>
                    </div>
                    
                    <!-- 檔案列表 -->
                    <div class="file-list" id="fileList"></div>
                    
                    <!-- 向量化風格 -->
                    <div class="settings-block">
                        <div class="settings-title">
                            <span>🎨</span>
                            <span>向量化風格</span>
                        </div>
                        <div class="style-grid">
                            <button class="style-btn active" data-style="clean" onclick="selectStyle('clean')">
                                <span class="style-icon">✨</span>
                                <span>簡潔扁平</span>
                            </button>
                            <button class="style-btn" data-style="outline" onclick="selectStyle('outline')">
                                <span class="style-icon">✏️</span>
                                <span>線稿描邊</span>
                            </button>
                            <button class="style-btn" data-style="gradient" onclick="selectStyle('gradient')">
                                <span class="style-icon">🌈</span>
                                <span>漸層質感</span>
                            </button>
                            <button class="style-btn" data-style="sketch" onclick="selectStyle('sketch')">
                                <span class="style-icon">🖌️</span>
                                <span>手繪風格</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 場景模板 -->
                    <div class="settings-block">
                        <div class="settings-title">
                            <span>📐</span>
                            <span>輸出場景</span>
                        </div>
                        <div class="template-grid">
                            <button class="template-btn active" data-template="presentation" onclick="selectTemplate('presentation')" title="適合簡報使用，元素清晰可見，配色對比度高">
                                <span class="template-icon">🎯</span>
                                <span>簡報</span>
                            </button>
                            <button class="template-btn" data-template="education" onclick="selectTemplate('education')" title="適合教學素材，保留標註和說明元素">
                                <span class="template-icon">📚</span>
                                <span>教學</span>
                            </button>
                            <button class="template-btn" data-template="social" onclick="selectTemplate('social')" title="適合社群媒體，風格活潑有創意">
                                <span class="template-icon">📱</span>
                                <span>社群</span>
                            </button>
                            <button class="template-btn" data-template="print" onclick="selectTemplate('print')" title="適合印刷輸出，高解析度，細節完整">
                                <span class="template-icon">🖨️</span>
                                <span>印刷</span>
                            </button>
                            <button class="template-btn" data-template="icon" onclick="selectTemplate('icon')" title="適合圖標設計，極簡風格，高度識別性">
                                <span class="template-icon">🔷</span>
                                <span>圖標</span>
                            </button>
                            <button class="template-btn" data-template="custom" onclick="selectTemplate('custom')" title="使用下方自訂提示詞">
                                <span class="template-icon">✏️</span>
                                <span>自訂</span>
                            </button>
                        </div>
                        <div class="custom-prompt-wrapper" id="customPromptWrapper" style="display: none; margin-top: 12px;">
                            <textarea class="custom-prompt-input" id="customPromptInput" placeholder="輸入自訂的轉換提示詞..." rows="3"></textarea>
                        </div>
                    </div>
                    
                    <!-- 進階設定 -->
                    <div class="settings-block">
                        <div class="advanced-toggle" id="advancedToggle" onclick="toggleAdvanced()">
                            <span class="advanced-toggle-text">
                                <span>⚡</span>
                                <span>進階設定</span>
                            </span>
                            <span class="advanced-toggle-icon">▼</span>
                        </div>
                        <div class="advanced-panel" id="advancedPanel">
                            <div class="advanced-row">
                                <span class="advanced-label">輸出寬度</span>
                                <input type="number" class="advanced-input" id="outputWidth" value="1024" min="100" max="4096">
                            </div>
                            <div class="advanced-row">
                                <span class="advanced-label">路徑簡化</span>
                                <select class="advanced-select" id="pathSimplify">
                                    <option value="low">低（保留細節）</option>
                                    <option value="medium" selected>中（平衡）</option>
                                    <option value="high">高（極簡）</option>
                                </select>
                            </div>
                            <div class="advanced-row">
                                <span class="advanced-label">色彩數量</span>
                                <select class="advanced-select" id="colorCount">
                                    <option value="auto" selected>自動</option>
                                    <option value="8">8 色</option>
                                    <option value="16">16 色</option>
                                    <option value="32">32 色</option>
                                    <option value="64">64 色</option>
                                </select>
                            </div>
                            <div class="advanced-row">
                                <label class="advanced-checkbox">
                                    <input type="checkbox" class="checkbox-input" id="removeBackground">
                                    <span>移除背景</span>
                                </label>
                            </div>
                            <div class="advanced-row">
                                <label class="advanced-checkbox">
                                    <input type="checkbox" class="checkbox-input" id="optimizeSVG" checked>
                                    <span>優化 SVG 大小</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 轉換按鈕 -->
                <div class="convert-section">
                    <button class="convert-btn" id="convertBtn" onclick="startConversion()" disabled>
                        <span class="convert-btn-icon">⚗️</span>
                        <span>開始煉金轉換</span>
                    </button>
                </div>
            </aside>
            
            <!-- 中央工作區 -->
            <section class="workspace">
                <!-- 工具列 -->
                <div class="workspace-toolbar">
                    <div class="toolbar-group">
                        <button class="toolbar-btn" id="undoBtn" title="復原 (Ctrl+Z)" disabled>↩️</button>
                        <button class="toolbar-btn" id="redoBtn" title="重做 (Ctrl+Y)" disabled>↪️</button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <div class="toolbar-group">
                        <button class="toolbar-btn" id="selectTool" title="選取工具 (V)">🔲</button>
                        <button class="toolbar-btn" id="moveTool" title="移動工具 (M)">✋</button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <div class="toolbar-group">
                        <button class="toolbar-btn" id="colorPickerTool" title="顏色選取器 (I)">🎨</button>
                        <button class="toolbar-btn" id="eraserTool" title="橡皮擦 (E)">🧹</button>
                    </div>
                    
                    <span class="toolbar-label" id="toolbarInfo">就緒</span>
                    
                    <div class="toolbar-spacer"></div>
                    
                    <div class="zoom-controls">
                        <button class="toolbar-btn" id="zoomOutBtn" title="縮小">➖</button>
                        <span class="zoom-value" id="zoomValue">100%</span>
                        <button class="toolbar-btn" id="zoomInBtn" title="放大">➕</button>
                        <button class="toolbar-btn" id="zoomFitBtn" title="適合視窗">🔍</button>
                    </div>
                </div>
                
                <!-- 畫布區域 -->
                <div class="canvas-container" id="canvasContainer">
                    <div class="canvas-empty" id="canvasEmpty">
                        <div class="canvas-empty-icon">🔮</div>
                        <div class="canvas-empty-title">等待煉金轉換</div>
                        <div class="canvas-empty-desc">上傳檔案並開始轉換，您的向量圖將在此顯示</div>
                    </div>
                    <div class="canvas-viewport" id="canvasViewport" style="display: none;">
                        <div class="canvas-content" id="canvasContent"></div>
                    </div>
                </div>
            </section>
            
            <!-- 右側邊欄 - 編輯區 -->
            <aside class="sidebar-right" id="sidebarRight">
                <!-- 標籤頁 -->
                <div class="editor-tabs">
                    <button class="editor-tab active" data-tab="layers" onclick="switchEditorTab('layers')">
                        <span>📑</span>
                        <span>圖層</span>
                    </button>
                    <button class="editor-tab" data-tab="colors" onclick="switchEditorTab('colors')">
                        <span>🎨</span>
                        <span>顏色</span>
                    </button>
                    <button class="editor-tab" data-tab="transform" onclick="switchEditorTab('transform')">
                        <span>📐</span>
                        <span>變換</span>
                    </button>
                    <button class="editor-tab" data-tab="history" onclick="switchEditorTab('history')">
                        <span>📜</span>
                        <span>歷史</span>
                    </button>
                </div>
                
                <!-- 編輯內容 -->
                <div class="editor-content">
                    <!-- 圖層面板 -->
                    <div class="editor-panel" id="layersPanel">
                        <div class="editor-section">
                            <div class="editor-section-title">
                                <span>📑</span>
                                <span>SVG 元素</span>
                            </div>
                            <div class="layer-list" id="layerList">
                                <div class="canvas-empty" style="padding: 24px;">
                                    <div class="canvas-empty-icon" style="font-size: 2.5rem;">📑</div>
                                    <div class="canvas-empty-desc" style="font-size: 0.8rem;">尚無圖層</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 顏色面板 -->
                    <div class="editor-panel" id="colorsPanel" style="display: none;">
                        <div class="editor-section">
                            <div class="editor-section-title">
                                <span>🎨</span>
                                <span>填充顏色</span>
                            </div>
                            <div class="color-palette" id="fillPalette">
                                <div class="color-swatch selected" style="background: #000000;" data-color="#000000"></div>
                                <div class="color-swatch" style="background: #ffffff; border: 1px solid var(--border-color);" data-color="#ffffff"></div>
                                <div class="color-swatch" style="background: #ef4444;" data-color="#ef4444"></div>
                                <div class="color-swatch" style="background: #f97316;" data-color="#f97316"></div>
                                <div class="color-swatch" style="background: #eab308;" data-color="#eab308"></div>
                                <div class="color-swatch" style="background: #22c55e;" data-color="#22c55e"></div>
                                <div class="color-swatch" style="background: #06b6d4;" data-color="#06b6d4"></div>
                                <div class="color-swatch" style="background: #3b82f6;" data-color="#3b82f6"></div>
                                <div class="color-swatch" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                                <div class="color-swatch" style="background: #ec4899;" data-color="#ec4899"></div>
                            </div>
                            <div class="color-custom">
                                <div class="color-picker-wrapper">
                                    <input type="color" class="color-picker" id="fillColorPicker" value="#000000">
                                </div>
                                <input type="text" class="color-hex-input" id="fillHexInput" value="#000000" placeholder="#000000">
                                <button class="apply-color-btn" onclick="applyFillColor()" title="套用到選取的圖層">套用</button>
                            </div>
                        </div>
                        
                        <div class="editor-section">
                            <div class="editor-section-title">
                                <span>✏️</span>
                                <span>描邊顏色</span>
                            </div>
                            <div class="color-palette" id="strokePalette">
                                <div class="color-swatch selected" style="background: #000000;" data-color="#000000"></div>
                                <div class="color-swatch" style="background: #ffffff; border: 1px solid var(--border-color);" data-color="#ffffff"></div>
                                <div class="color-swatch" style="background: #ef4444;" data-color="#ef4444"></div>
                                <div class="color-swatch" style="background: #f97316;" data-color="#f97316"></div>
                                <div class="color-swatch" style="background: #eab308;" data-color="#eab308"></div>
                                <div class="color-swatch" style="background: #22c55e;" data-color="#22c55e"></div>
                                <div class="color-swatch" style="background: #06b6d4;" data-color="#06b6d4"></div>
                                <div class="color-swatch" style="background: #3b82f6;" data-color="#3b82f6"></div>
                                <div class="color-swatch" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                                <div class="color-swatch" style="background: #ec4899;" data-color="#ec4899"></div>
                            </div>
                            <div class="color-custom">
                                <div class="color-picker-wrapper">
                                    <input type="color" class="color-picker" id="strokeColorPicker" value="#000000">
                                </div>
                                <input type="text" class="color-hex-input" id="strokeHexInput" value="#000000" placeholder="#000000">
                                <button class="apply-color-btn" onclick="applyStrokeColor()" title="套用到選取的圖層">套用</button>
                            </div>
                        </div>
                        
                        <div class="editor-section">
                            <div class="editor-section-title">
                                <span>🖼️</span>
                                <span>提取的顏色</span>
                            </div>
                            <div class="color-palette" id="extractedColors">
                                <div class="canvas-empty" style="padding: 16px; grid-column: 1/-1;">
                                    <div class="canvas-empty-desc" style="font-size: 0.75rem;">轉換後顯示提取的顏色</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 變換面板 -->
                    <div class="editor-panel" id="transformPanel" style="display: none;">
                        <div class="editor-section">
                            <div class="editor-section-title">
                                <span>📏</span>
                                <span>尺寸</span>
                            </div>
                            <div class="transform-grid">
                                <div class="transform-item">
                                    <span class="transform-label">寬度</span>
                                    <input type="number" class="transform-input" id="transformWidth" value="0">
                                </div>
                                <div class="transform-item">
                                    <span class="transform-label">高度</span>
                                    <input type="number" class="transform-input" id="transformHeight" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="editor-section">
                            <div class="editor-section-title">
                                <span>📍</span>
                                <span>位置</span>
                            </div>
                            <div class="transform-grid">
                                <div class="transform-item">
                                    <span class="transform-label">X</span>
                                    <input type="number" class="transform-input" id="transformX" value="0">
                                </div>
                                <div class="transform-item">
                                    <span class="transform-label">Y</span>
                                    <input type="number" class="transform-input" id="transformY" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="editor-section">
                            <div class="editor-section-title">
                                <span>🔄</span>
                                <span>旋轉與縮放</span>
                            </div>
                            <div class="transform-grid">
                                <div class="transform-item">
                                    <span class="transform-label">旋轉 (°)</span>
                                    <input type="number" class="transform-input" id="transformRotation" value="0">
                                </div>
                                <div class="transform-item">
                                    <span class="transform-label">縮放 (%)</span>
                                    <input type="number" class="transform-input" id="transformScale" value="100">
                                </div>
                            </div>
                        </div>
                        
                        <div class="editor-section">
                            <button class="apply-transform-btn" onclick="applyTransform()">✨ 套用變換</button>
                        </div>
                    </div>
                    
                    <!-- 歷史面板 -->
                    <div class="editor-panel" id="historyPanel" style="display: none;">
                        <div class="editor-section">
                            <div class="editor-section-title">
                                <span>📜</span>
                                <span>操作歷史</span>
                            </div>
                            <div class="history-list" id="historyList">
                                <div class="canvas-empty" style="padding: 24px;">
                                    <div class="canvas-empty-icon" style="font-size: 2.5rem;">📜</div>
                                    <div class="canvas-empty-desc" style="font-size: 0.8rem;">尚無操作記錄</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 輸出面板 -->
                <div class="output-panel">
                    <div class="settings-title">✨ 煉成品</div>
                    <div class="output-grid" id="outputGrid">
                        <div class="canvas-empty" style="padding: 24px; grid-column: 1/-1;">
                            <div class="canvas-empty-icon" style="font-size: 2rem;">🔮</div>
                            <div class="canvas-empty-desc" style="font-size: 0.75rem;">等待轉換結果</div>
                        </div>
                    </div>
                    <div class="batch-actions" id="batchActions" style="display: none;">
                        <button class="batch-btn" onclick="exportModal.show()">
                            <span>📦</span>
                            <span>導出</span>
                        </button>
                        <button class="batch-btn primary" onclick="downloadAllSVG()">
                            <span>💾</span>
                            <span>全部下載</span>
                        </button>
                    </div>
                </div>
            </aside>
        </main>
    </div>
    
    <!-- 進度 Overlay -->
    <div class="progress-overlay" id="progressOverlay">
        <div class="progress-content">
            <div class="progress-alchemy">
                <div class="progress-circle"></div>
                <div class="progress-circle"></div>
                <div class="progress-circle"></div>
                <div class="progress-symbol">⚗️</div>
            </div>
            <div class="progress-title" id="progressTitle">煉金中...</div>
            <div class="progress-step" id="progressStep">準備材料...</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressFill"></div>
            </div>
            <div class="progress-percent" id="progressPercent">0%</div>
            <button class="progress-cancel" onclick="cancelConversion()">取消轉換</button>
        </div>
    </div>
    
    <!-- 預覽 Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-container">
            <div class="preview-header">
                <div class="preview-title">
                    <span>🔍</span>
                    <span id="previewTitle">預覽</span>
                </div>
                <button class="preview-close" onclick="closePreview()">✕</button>
            </div>
            <div class="preview-body" id="previewBody"></div>
            <div class="preview-footer">
                <button class="preview-btn" onclick="copyCurrentSVG()">
                    <span>📋</span>
                    <span>複製 SVG</span>
                </button>
                <button class="preview-btn" onclick="downloadCurrentPNG()">
                    <span>🖼️</span>
                    <span>下載 PNG</span>
                </button>
                <button class="preview-btn primary" onclick="downloadCurrentSVG()">
                    <span>💾</span>
                    <span>下載 SVG</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 導出 Modal -->
    <div class="export-modal" id="exportModal">
        <div class="export-container">
            <div class="export-header">
                <span class="export-title">📦 導出設定</span>
                <button class="preview-close" onclick="closeExportModal()">✕</button>
            </div>
            <div class="export-body">
                <div class="export-section">
                    <div class="export-section-title">輸出格式</div>
                    <div class="export-format-grid">
                        <button class="export-format-btn selected" data-format="svg" onclick="selectExportFormat('svg')">
                            <span class="export-format-icon">📐</span>
                            <span>SVG</span>
                        </button>
                        <button class="export-format-btn" data-format="png" onclick="selectExportFormat('png')">
                            <span class="export-format-icon">🖼️</span>
                            <span>PNG</span>
                        </button>
                        <button class="export-format-btn" data-format="jpg" onclick="selectExportFormat('jpg')">
                            <span class="export-format-icon">📷</span>
                            <span>JPG</span>
                        </button>
                    </div>
                </div>
                
                <div class="export-section" id="exportSizeSection">
                    <div class="export-section-title">輸出尺寸</div>
                    <div class="export-size-grid">
                        <div class="export-size-item">
                            <span class="export-size-label">寬度 (px)</span>
                            <input type="number" class="export-size-input" id="exportWidth" value="1024">
                        </div>
                        <div class="export-size-item">
                            <span class="export-size-label">高度 (px)</span>
                            <input type="number" class="export-size-input" id="exportHeight" value="1024">
                        </div>
                    </div>
                </div>
                
                <div class="export-section">
                    <div class="export-section-title">快速尺寸預設</div>
                    <div class="export-preset-grid">
                        <button class="export-preset-btn" onclick="setExportPreset(1080, 1080)">
                            <div class="export-preset-name">Instagram</div>
                            <div class="export-preset-size">1080 × 1080</div>
                        </button>
                        <button class="export-preset-btn" onclick="setExportPreset(1200, 630)">
                            <div class="export-preset-name">Facebook</div>
                            <div class="export-preset-size">1200 × 630</div>
                        </button>
                        <button class="export-preset-btn" onclick="setExportPreset(1920, 1080)">
                            <div class="export-preset-name">簡報 16:9</div>
                            <div class="export-preset-size">1920 × 1080</div>
                        </button>
                        <button class="export-preset-btn" onclick="setExportPreset(2480, 3508)">
                            <div class="export-preset-name">A4 印刷</div>
                            <div class="export-preset-size">2480 × 3508</div>
                        </button>
                    </div>
                </div>
            </div>
            <div class="export-footer">
                <button class="preview-btn" onclick="closeExportModal()">取消</button>
                <button class="preview-btn primary" onclick="executeExport()">
                    <span>📦</span>
                    <span>導出</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 設定 Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-container">
            <div class="settings-header">
                <span class="settings-title">⚙️ 設定</span>
                <button class="preview-close" onclick="closeSettingsModal()">✕</button>
            </div>
            <div class="settings-body">
                <div class="settings-group">
                    <div class="settings-group-title">外觀設定</div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">深色模式</div>
                            <div class="settings-desc">切換深色/淺色主題</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">動畫效果</div>
                            <div class="settings-desc">啟用背景動畫</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="animationToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <div class="settings-group-title">轉換設定</div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">自動優化 SVG</div>
                            <div class="settings-desc">轉換後自動壓縮 SVG</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoOptimizeToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">保留原始比例</div>
                            <div class="settings-desc">導出時維持原始長寬比</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="keepRatioToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <div class="settings-group-title">進階設定</div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">首次使用教學</div>
                            <div class="settings-desc">下次啟動時顯示導覽</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tutorialToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 快捷鍵 Modal -->
    <div class="shortcuts-modal" id="shortcutsModal">
        <div class="shortcuts-container">
            <div class="shortcuts-header">
                <span class="shortcuts-title">⌨️ 快捷鍵</span>
                <button class="preview-close" onclick="closeShortcutsModal()">✕</button>
            </div>
            <div class="shortcuts-body">
                <div class="shortcuts-group">
                    <div class="shortcuts-group-title">一般操作</div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">復原</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key">Z</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">重做</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key">Y</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">全選</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key">A</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">刪除選取</span>
                        <div class="shortcut-keys">
                            <span class="key">Delete</span>
                        </div>
                    </div>
                </div>
                
                <div class="shortcuts-group">
                    <div class="shortcuts-group-title">工具</div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">選取工具</span>
                        <div class="shortcut-keys">
                            <span class="key">V</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">移動工具</span>
                        <div class="shortcut-keys">
                            <span class="key">M</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">顏色選取器</span>
                        <div class="shortcut-keys">
                            <span class="key">I</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">橡皮擦</span>
                        <div class="shortcut-keys">
                            <span class="key">E</span>
                        </div>
                    </div>
                </div>
                
                <div class="shortcuts-group">
                    <div class="shortcuts-group-title">檢視</div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">放大</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key">+</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">縮小</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key">-</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">適合視窗</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="shortcuts-group">
                    <div class="shortcuts-group-title">檔案</div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">開啟檔案</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key">O</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">儲存</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key">S</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-desc">導出</span>
                        <div class="shortcut-keys">
                            <span class="key">Ctrl</span>
                            <span class="key">E</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 教學導覽 -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-spotlight" id="tutorialSpotlight"></div>
        <div class="tutorial-popup" id="tutorialPopup">
            <div class="tutorial-step" id="tutorialStepLabel">步驟 1 / 5</div>
            <div class="tutorial-title" id="tutorialTitle">歡迎使用向量化煉金工坊</div>
            <div class="tutorial-desc" id="tutorialDesc">這個工具可以將 PDF 和圖片轉換為可編輯的 SVG 向量圖。讓我們開始導覽吧！</div>
            <div class="tutorial-actions">
                <button class="tutorial-btn" id="tutorialSkip" onclick="skipTutorial()">跳過</button>
                <button class="tutorial-btn primary" id="tutorialNext" onclick="nextTutorialStep()">下一步</button>
            </div>
            <div class="tutorial-progress" id="tutorialProgress">
                <div class="tutorial-dot active"></div>
                <div class="tutorial-dot"></div>
                <div class="tutorial-dot"></div>
                <div class="tutorial-dot"></div>
                <div class="tutorial-dot"></div>
            </div>
        </div>
    </div>
    
    <!-- Toast 容器 -->
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        // ============================================
        // PDF.js 設定
        // ============================================
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // ============================================
        // 全域狀態管理
        // ============================================
        const AppState = {
            // API
            apiKey: '',
            apiConnected: false,
            
            // 檔案
            files: [],
            outputs: [],
            currentPreviewIndex: -1,
            
            // 設定
            selectedStyle: 'clean',
            selectedTemplate: 'presentation',
            
            // 編輯器
            currentTab: 'layers',
            selectedLayer: null,
            currentTool: 'select',
            zoom: 1,
            
            // 歷史記錄
            history: [],
            historyIndex: -1,
            maxHistory: 50,
            
            // 轉換
            isConverting: false,
            conversionCancelled: false,
            
            // 教學
            tutorialStep: 0,
            tutorialShown: false,
            
            // 設定
            settings: {
                darkMode: true,
                animations: true,
                autoOptimize: true,
                keepRatio: true,
                showTutorial: true
            }
        };
        
        // 風格提示詞
        const StylePrompts = {
            clean: '使用簡潔扁平的設計風格，純色填充，沒有漸層，清晰的輪廓線條，適合現代簡報使用。移除不必要的細節，保留主要形狀。',
            outline: '使用線稿描邊風格，主要使用線條勾勒輪廓，最小化填充色，類似手繪素描的效果。線條粗細要一致，約2-3px。',
            gradient: '使用漸層質感設計，可以使用線性或放射漸層增加深度感，保持配色和諧，適合高質感的設計需求。',
            sketch: '使用手繪風格，線條可以略微不規則，有手繪的溫度感，適合創意和藝術類的設計。可以有輕微的陰影和質感。'
        };
        
        // 場景提示詞
        const TemplatePrompts = {
            presentation: '適合簡報使用，元素要清晰可見，在投影時也能辨識。配色對比度高，避免過於複雜的細節。',
            education: '適合教學素材，保留重要的標註和說明元素，可以加入指示性的箭頭或數字標記。',
            social: '適合社群媒體，風格活潑有創意，使用鮮明的色彩，吸引眼球的設計。',
            print: '適合印刷輸出，高解析度，色彩飽和，細節保留完整，考慮 CMYK 色彩空間。',
            icon: '適合圖標設計，極簡風格，高度識別性，適合各種尺寸縮放。使用純色，避免漸層。',
            custom: '根據原圖的特性自動判斷最適合的風格，保持原有的設計意圖。'
        };
        
        // 教學步驟
        const TutorialSteps = [
            {
                target: '.api-block',
                title: '輸入 API Key',
                desc: '首先，請輸入您的 Gemini API Key。這是使用 AI 向量化功能的必要條件。'
            },
            {
                target: '.upload-zone',
                title: '上傳檔案',
                desc: '將 PDF 或圖片拖放到這裡，或點擊選擇檔案。支援批次上傳多個檔案。'
            },
            {
                target: '.style-grid',
                title: '選擇向量化風格',
                desc: '根據您的需求選擇不同的向量化風格：簡潔扁平、線稿描邊、漸層質感或手繪風格。'
            },
            {
                target: '.convert-btn',
                title: '開始轉換',
                desc: '一切準備就緒後，點擊這個按鈕開始 AI 向量化轉換。'
            },
            {
                target: '.sidebar-right',
                title: '編輯您的向量圖',
                desc: '轉換完成後，您可以在這裡編輯圖層、調整顏色、變換尺寸，並查看操作歷史。'
            }
        ];
        
        // ============================================
        // 初始化
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initSplashScreen();
        });
        
        function initSplashScreen() {
            const splash = document.getElementById('splashScreen');
            const progress = document.getElementById('splashProgress');
            const status = document.getElementById('splashStatus');
            
            const steps = [
                { percent: 20, text: '載入核心模組...' },
                { percent: 40, text: '初始化 PDF 解析器...' },
                { percent: 60, text: '準備向量化引擎...' },
                { percent: 80, text: '載入使用者介面...' },
                { percent: 100, text: '準備完成！' }
            ];
            
            let currentStep = 0;
            
            const updateProgress = () => {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    progress.style.width = step.percent + '%';
                    status.textContent = step.text;
                    currentStep++;
                    
                    if (currentStep < steps.length) {
                        setTimeout(updateProgress, 400);
                    } else {
                        setTimeout(() => {
                            splash.classList.add('hidden');
                            initApp();
                        }, 500);
                    }
                }
            };
            
            setTimeout(updateProgress, 300);
        }
        
        function initApp() {
            initParticles();
            initUploadZone();
            initApiInput();
            initSidebars();
            initToolbar();
            initColorPickers();
            initTransform();
            initKeyboardShortcuts();
            initSettings();
            
            // 檢查是否需要顯示教學
            if (AppState.settings.showTutorial && !AppState.tutorialShown) {
                setTimeout(() => showTutorial(), 500);
            }
        }
        
        // ============================================
        // 背景粒子效果
        // ============================================
        function initParticles() {
            const bg = document.getElementById('alchemyBg');
            for (let i = 0; i < 25; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.animationDuration = (8 + Math.random() * 6) + 's';
                bg.appendChild(particle);
            }
        }
        
        // ============================================
        // API Key 處理
        // ============================================
        function initApiInput() {
            const input = document.getElementById('apiKeyInput');
            const toggleBtn = document.getElementById('apiToggleVisibility');
            const verifyBtn = document.getElementById('apiVerifyBtn');
            let isVisible = false;
            
            input.addEventListener('input', (e) => {
                const key = e.target.value.trim();
                if (key.length > 20) {
                    AppState.apiKey = key;
                    updateApiStatus(false, '請點擊驗證');
                } else {
                    AppState.apiKey = '';
                    AppState.apiConnected = false;
                    updateApiStatus(false);
                }
                updateConvertButton();
            });
            
            toggleBtn.addEventListener('click', () => {
                isVisible = !isVisible;
                input.type = isVisible ? 'text' : 'password';
                toggleBtn.textContent = isVisible ? '🔒' : '👁️';
            });
            
            // 驗證按鈕事件
            if (verifyBtn) {
                verifyBtn.addEventListener('click', verifyApiKey);
            }
        }
        
        async function verifyApiKey() {
            const key = AppState.apiKey;
            if (!key || key.length < 20) {
                showToast('請輸入有效的 API Key', 'warning');
                return;
            }
            
            updateApiStatus(false, '驗證中...');
            
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: 'Reply with just: OK' }] }],
                            generationConfig: { maxOutputTokens: 10 }
                        })
                    }
                );
                
                if (response.ok) {
                    AppState.apiConnected = true;
                    updateApiStatus(true, '驗證成功');
                    showToast('API Key 驗證成功！', 'success');
                    updateConvertButton();
                    addToHistory('api_verify', 'API Key 驗證成功');
                } else {
                    const error = await response.json();
                    throw new Error(error.error?.message || '驗證失敗');
                }
            } catch (e) {
                AppState.apiConnected = false;
                updateApiStatus(false, '驗證失敗');
                showToast('API Key 驗證失敗: ' + e.message, 'error');
            }
        }
        
        function updateApiStatus(connected, customText = null) {
            const dot = document.getElementById('apiStatusDot');
            const text = document.getElementById('apiStatusText');
            
            if (connected) {
                dot.classList.add('connected');
                text.classList.add('connected');
                text.textContent = customText || '已連接';
            } else {
                dot.classList.remove('connected');
                text.classList.remove('connected');
                text.textContent = customText || '尚未連接';
            }
        }
        
        // ============================================
        // 側邊欄控制
        // ============================================
        function initSidebars() {
            const leftToggle = document.getElementById('toggleLeftSidebar');
            const rightToggle = document.getElementById('toggleRightSidebar');
            const leftSidebar = document.getElementById('sidebarLeft');
            const rightSidebar = document.getElementById('sidebarRight');
            const overlay = document.getElementById('sidebarOverlay');
            
            // 桌面版：收合/展開側邊欄
            leftToggle.addEventListener('click', () => {
                const isCollapsed = leftSidebar.classList.toggle('collapsed');
                leftToggle.classList.toggle('active', !isCollapsed);
                
                // 手機版邏輯
                if (window.innerWidth <= 1024) {
                    leftSidebar.classList.toggle('open');
                    rightSidebar.classList.remove('open');
                    overlay.classList.toggle('show', leftSidebar.classList.contains('open'));
                }
                
                showToast(isCollapsed ? '輸入面板已收合' : '輸入面板已展開', 'info');
            });
            
            rightToggle.addEventListener('click', () => {
                const isCollapsed = rightSidebar.classList.toggle('collapsed');
                rightToggle.classList.toggle('active', !isCollapsed);
                
                // 手機版邏輯
                if (window.innerWidth <= 1024) {
                    rightSidebar.classList.toggle('open');
                    leftSidebar.classList.remove('open');
                    overlay.classList.toggle('show', rightSidebar.classList.contains('open'));
                }
                
                showToast(isCollapsed ? '編輯面板已收合' : '編輯面板已展開', 'info');
            });
            
            overlay.addEventListener('click', () => {
                leftSidebar.classList.remove('open');
                rightSidebar.classList.remove('open');
                overlay.classList.remove('show');
            });
            
            // 預設：按鈕為 active（面板展開中）
            leftToggle.classList.add('active');
            rightToggle.classList.add('active');
        }
        
        // ============================================
        // 上傳區域
        // ============================================
        function initUploadZone() {
            const zone = document.getElementById('uploadZone');
            const input = document.getElementById('fileInput');
            
            zone.addEventListener('click', () => input.click());
            
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
            
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            input.addEventListener('change', (e) => {
                handleFiles(e.target.files);
                input.value = '';
            });
        }
        
        async function handleFiles(fileList) {
            const validExtensions = ['pdf', 'jpg', 'jpeg', 'png', 'webp', 'gif'];
            let addedCount = 0;
            
            for (const file of fileList) {
                const ext = file.name.split('.').pop().toLowerCase();
                
                if (!validExtensions.includes(ext)) {
                    showToast(`不支援的格式: ${file.name}`, 'error');
                    continue;
                }
                
                // 檢查同名檔案，如果存在則移除舊的
                const existingIndex = AppState.files.findIndex(f => f.name === file.name);
                if (existingIndex !== -1) {
                    AppState.files.splice(existingIndex, 1);
                }
                
                const fileData = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    file: file,
                    type: ext === 'pdf' ? 'pdf' : 'image',
                    size: formatFileSize(file.size),
                    status: 'pending',
                    thumb: null,
                    images: []
                };
                
                // 生成縮圖
                if (fileData.type === 'image') {
                    fileData.thumb = await createImageThumb(file);
                    fileData.images = [await fileToBase64(file)];
                } else {
                    fileData.thumb = '📄';
                }
                
                AppState.files.push(fileData);
                addedCount++;
            }
            
            renderFileList();
            updateConvertButton();
            
            showToast(`已添加 ${addedCount} 個檔案`, 'success');
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function createImageThumb(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }
        
        function fileToBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result.split(',')[1];
                    resolve(base64);
                };
                reader.readAsDataURL(file);
            });
        }
        
        function renderFileList() {
            const list = document.getElementById('fileList');
            
            if (AppState.files.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            list.innerHTML = AppState.files.map((f, i) => `
                <div class="file-item" data-id="${f.id}">
                    <div class="file-thumb">
                        ${f.thumb && f.thumb.startsWith('data:') 
                            ? `<img src="${f.thumb}" alt="${f.name}">`
                            : f.thumb || '📄'}
                    </div>
                    <div class="file-info">
                        <div class="file-name">${escapeHtml(f.name)}</div>
                        <div class="file-meta">${f.type === 'pdf' ? 'PDF' : '圖片'} • ${f.size}</div>
                    </div>
                    <span class="file-status ${f.status}">${getStatusText(f.status)}</span>
                    ${f.status === 'done' || f.status === 'error' 
                        ? `<button class="file-reset" onclick="resetFile(${i})" title="重新轉換">🔄</button>`
                        : ''}
                    <button class="file-remove" onclick="removeFile(${i})" title="移除">✕</button>
                </div>
            `).join('');
        }
        
        function getStatusText(status) {
            const texts = {
                pending: '待處理',
                processing: '處理中',
                done: '完成',
                error: '失敗'
            };
            return texts[status] || status;
        }
        
        function removeFile(index) {
            AppState.files.splice(index, 1);
            renderFileList();
            updateConvertButton();
        }
        
        function resetFile(index) {
            if (AppState.files[index]) {
                AppState.files[index].status = 'pending';
                AppState.files[index].error = null;
                renderFileList();
                updateConvertButton();
                showToast(`${AppState.files[index].name} 已重置，可重新轉換`, 'info');
            }
        }
        
        function resetAllFiles() {
            AppState.files.forEach(f => {
                if (f.status !== 'processing') {
                    f.status = 'pending';
                    f.error = null;
                }
            });
            renderFileList();
            updateConvertButton();
            showToast('所有檔案已重置', 'info');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ============================================
        // 風格與模板選擇
        // ============================================
        function selectStyle(style) {
            AppState.selectedStyle = style;
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.style === style);
            });
        }
        
        function selectTemplate(template) {
            AppState.selectedTemplate = template;
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.template === template);
            });
            
            // 顯示/隱藏自訂提示詞輸入框
            const customWrapper = document.getElementById('customPromptWrapper');
            if (customWrapper) {
                customWrapper.style.display = template === 'custom' ? 'block' : 'none';
            }
        }
        
        // ============================================
        // 進階設定
        // ============================================
        function toggleAdvanced() {
            const toggle = document.getElementById('advancedToggle');
            const panel = document.getElementById('advancedPanel');
            
            toggle.classList.toggle('open');
            panel.classList.toggle('show');
        }
        
        // ============================================
        // 轉換按鈕狀態
        // ============================================
        function updateConvertButton() {
            const btn = document.getElementById('convertBtn');
            btn.disabled = !AppState.apiConnected || AppState.files.length === 0 || AppState.isConverting;
        }
        
        // ============================================
        // 轉換流程
        // ============================================
        async function startConversion() {
            if (!AppState.apiConnected || AppState.files.length === 0) return;
            
            AppState.isConverting = true;
            AppState.conversionCancelled = false;
            updateConvertButton();
            
            showProgress('準備材料...', 0);
            
            const totalFiles = AppState.files.length;
            let processedFiles = 0;
            
            try {
                for (const fileData of AppState.files) {
                    if (AppState.conversionCancelled) {
                        showToast('轉換已取消', 'warning');
                        break;
                    }
                    
                    fileData.status = 'processing';
                    renderFileList();
                    
                    // PDF 轉圖片
                    if (fileData.type === 'pdf') {
                        updateProgress('📜 提取 PDF 頁面...', (processedFiles / totalFiles) * 50);
                        fileData.images = await pdfToImages(fileData.file);
                    }
                    
                    // 圖片轉 SVG
                    for (let i = 0; i < fileData.images.length; i++) {
                        if (AppState.conversionCancelled) break;
                        
                        const pageInfo = fileData.images.length > 1 ? ` (${i + 1}/${fileData.images.length})` : '';
                        updateProgress(`⚗️ 煉金轉換${pageInfo}...`, 50 + (processedFiles / totalFiles) * 50);
                        
                        const svgResult = await imageToSVG(fileData.images[i], fileData.name, i);
                        
                        if (svgResult) {
                            const outputName = fileData.images.length > 1
                                ? `${fileData.name.replace(/\.[^.]+$/, '')}_page${i + 1}.svg`
                                : `${fileData.name.replace(/\.[^.]+$/, '')}.svg`;
                            
                            AppState.outputs.push({
                                id: Date.now() + Math.random(),
                                name: outputName,
                                svg: svgResult,
                                sourceImage: fileData.images[i],
                                colors: extractColors(svgResult)
                            });
                        }
                    }
                    
                    fileData.status = AppState.conversionCancelled ? 'pending' : 'done';
                    processedFiles++;
                    renderFileList();
                }
                
                hideProgress();
                
                if (!AppState.conversionCancelled && AppState.outputs.length > 0) {
                    renderOutputs();
                    showCanvas();
                    addToHistory('轉換完成', `${AppState.outputs.length} 個檔案`);
                    showToast(`煉金完成！已轉換 ${AppState.outputs.length} 個向量圖`, 'success');
                }
                
            } catch (err) {
                console.error('轉換錯誤:', err);
                hideProgress();
                showToast('轉換過程發生錯誤: ' + err.message, 'error');
            }
            
            AppState.isConverting = false;
            updateConvertButton();
        }
        
        function cancelConversion() {
            AppState.conversionCancelled = true;
            hideProgress();
        }
        
        // ============================================
        // PDF 轉圖片
        // ============================================
        async function pdfToImages(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const images = [];
            const maxPages = 10;
            
            for (let i = 1; i <= Math.min(pdf.numPages, maxPages); i++) {
                if (AppState.conversionCancelled) break;
                
                const page = await pdf.getPage(i);
                const scale = 2;
                const viewport = page.getViewport({ scale });
                
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');
                
                await page.render({ canvasContext: ctx, viewport }).promise;
                
                const dataUrl = canvas.toDataURL('image/png');
                images.push(dataUrl.split(',')[1]);
            }
            
            return images;
        }
        
        // ============================================
        // 圖片轉 SVG（Gemini API）
        // ============================================
        async function imageToSVG(base64Image, fileName, pageIndex) {
            const stylePrompt = StylePrompts[AppState.selectedStyle];
            
            // 取得模板提示詞（自訂時使用用戶輸入）
            let templatePrompt;
            if (AppState.selectedTemplate === 'custom') {
                const customInput = document.getElementById('customPromptInput');
                templatePrompt = customInput?.value.trim() || '根據原圖的特性自動判斷最適合的風格';
            } else {
                templatePrompt = TemplatePrompts[AppState.selectedTemplate];
            }
            
            // 進階設定
            const outputWidth = document.getElementById('outputWidth')?.value || 1024;
            const pathSimplify = document.getElementById('pathSimplify')?.value || 'medium';
            const colorCount = document.getElementById('colorCount')?.value || 'auto';
            const removeBackground = document.getElementById('removeBackground')?.checked || false;
            
            const prompt = `你是專業的向量圖形轉換專家。請將這張圖片轉換為高品質的 SVG 格式。

## 風格要求
${stylePrompt}

## 用途場景
${templatePrompt}

## 技術規格
- 輸出寬度約 ${outputWidth}px，高度按比例
- 路徑簡化程度：${pathSimplify === 'low' ? '保留較多細節' : pathSimplify === 'high' ? '極度簡化' : '平衡細節與簡潔'}
- 色彩數量：${colorCount === 'auto' ? '自動判斷適當數量' : colorCount + ' 色以內'}
${removeBackground ? '- 請移除背景，只保留主要元素' : ''}

## SVG 要求
1. 輸出純粹的 SVG 代碼，以 <svg 開頭，以 </svg> 結尾
2. 設定適當的 viewBox
3. 使用 path、rect、circle、ellipse、polygon 等基本形狀
4. 保持圖形的主要特徵和比例
5. 使用語義化的 id 命名各元素（如 background、main-shape 等）
6. 不要包含任何解釋文字

請直接輸出 SVG 代碼：`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${AppState.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                {
                                    inline_data: {
                                        mime_type: 'image/png',
                                        data: base64Image
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 8192
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                // 提取 SVG
                let svgMatch = text.match(/<svg[\s\S]*?<\/svg>/i);
                if (svgMatch) {
                    return optimizeSVG(svgMatch[0]);
                }
                
                // 清理 markdown 後再找
                const cleaned = text.replace(/```(?:svg|xml)?\n?/gi, '').replace(/```\n?/gi, '').trim();
                svgMatch = cleaned.match(/<svg[\s\S]*?<\/svg>/i);
                if (svgMatch) {
                    return optimizeSVG(svgMatch[0]);
                }
                
                console.warn('無法提取 SVG:', text.substring(0, 300));
                return null;
                
            } catch (err) {
                console.error('Gemini API 錯誤:', err);
                throw err;
            }
        }
        
        // ============================================
        // SVG 優化
        // ============================================
        function optimizeSVG(svgString) {
            if (!document.getElementById('optimizeSVG')?.checked) {
                return svgString;
            }
            
            // 基本優化
            let optimized = svgString
                // 移除註解
                .replace(/<!--[\s\S]*?-->/g, '')
                // 移除多餘空白
                .replace(/\s+/g, ' ')
                .replace(/>\s+</g, '><')
                // 簡化數字
                .replace(/(\d+\.\d{4})\d+/g, '$1')
                // 移除空屬性
                .replace(/\s+[a-z-]+=""/gi, '');
            
            return optimized.trim();
        }
        
        // ============================================
        // 顏色提取
        // ============================================
        function extractColors(svgString) {
            const colors = new Set();
            
            // 提取 fill 顏色
            const fillMatches = svgString.match(/fill="(#[0-9a-fA-F]{3,6}|rgb\([^)]+\)|[a-z]+)"/gi) || [];
            fillMatches.forEach(match => {
                const color = match.match(/fill="([^"]+)"/i)?.[1];
                if (color && color !== 'none' && color !== 'transparent') {
                    colors.add(normalizeColor(color));
                }
            });
            
            // 提取 stroke 顏色
            const strokeMatches = svgString.match(/stroke="(#[0-9a-fA-F]{3,6}|rgb\([^)]+\)|[a-z]+)"/gi) || [];
            strokeMatches.forEach(match => {
                const color = match.match(/stroke="([^"]+)"/i)?.[1];
                if (color && color !== 'none' && color !== 'transparent') {
                    colors.add(normalizeColor(color));
                }
            });
            
            return Array.from(colors).slice(0, 10);
        }
        
        function normalizeColor(color) {
            // 簡單的顏色標準化
            if (color.startsWith('#')) {
                return color.toUpperCase();
            }
            if (color.startsWith('rgb')) {
                // 轉換 rgb 為 hex
                const match = color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/i);
                if (match) {
                    const r = parseInt(match[1]).toString(16).padStart(2, '0');
                    const g = parseInt(match[2]).toString(16).padStart(2, '0');
                    const b = parseInt(match[3]).toString(16).padStart(2, '0');
                    return `#${r}${g}${b}`.toUpperCase();
                }
            }
            return color;
        }
        
        // ============================================
        // 進度顯示
        // ============================================
        function showProgress(step, percent) {
            const overlay = document.getElementById('progressOverlay');
            overlay.classList.add('show');
            updateProgress(step, percent);
        }
        
        function updateProgress(step, percent) {
            document.getElementById('progressStep').textContent = step;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
        }
        
        function hideProgress() {
            document.getElementById('progressOverlay').classList.remove('show');
        }
        
        // ============================================
        // 輸出渲染
        // ============================================
        function renderOutputs() {
            const grid = document.getElementById('outputGrid');
            const batchActions = document.getElementById('batchActions');
            
            if (AppState.outputs.length === 0) {
                grid.innerHTML = `
                    <div class="canvas-empty" style="padding: 24px; grid-column: 1/-1;">
                        <div class="canvas-empty-icon" style="font-size: 2rem;">🔮</div>
                        <div class="canvas-empty-desc" style="font-size: 0.75rem;">等待轉換結果</div>
                    </div>
                `;
                batchActions.style.display = 'none';
                return;
            }
            
            grid.innerHTML = AppState.outputs.map((output, i) => `
                <div class="output-item ${AppState.currentPreviewIndex === i ? 'selected' : ''}" onclick="selectOutput(${i})">
                    <div class="output-preview">
                        ${output.svg}
                    </div>
                    <div class="output-info">
                        <div class="output-name">${escapeHtml(output.name)}</div>
                        <div class="output-actions">
                            <button class="output-btn" onclick="event.stopPropagation(); downloadSVG(${i})">SVG</button>
                            <button class="output-btn" onclick="event.stopPropagation(); downloadPNG(${i})">PNG</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            batchActions.style.display = 'flex';
            
            // 更新提取的顏色
            if (AppState.outputs.length > 0) {
                renderExtractedColors(AppState.outputs[0].colors);
            }
        }
        
        function selectOutput(index) {
            AppState.currentPreviewIndex = index;
            renderOutputs();
            
            const output = AppState.outputs[index];
            if (output) {
                showInCanvas(output.svg);
                renderLayers(output.svg);
                renderExtractedColors(output.colors);
            }
        }
        
        function renderExtractedColors(colors) {
            const container = document.getElementById('extractedColors');
            if (!colors || colors.length === 0) {
                container.innerHTML = `
                    <div class="canvas-empty" style="padding: 16px; grid-column: 1/-1;">
                        <div class="canvas-empty-desc" style="font-size: 0.75rem;">無提取顏色</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = colors.map(color => `
                <div class="color-swatch" style="background: ${color};" data-color="${color}" title="${color}" onclick="copyColor('${color}')"></div>
            `).join('');
        }
        
        function copyColor(color) {
            navigator.clipboard.writeText(color);
            showToast(`已複製顏色 ${color}`, 'success');
        }
        
        // ============================================
        // 畫布顯示
        // ============================================
        function showCanvas() {
            document.getElementById('canvasEmpty').style.display = 'none';
            document.getElementById('canvasViewport').style.display = 'block';
            
            if (AppState.outputs.length > 0) {
                selectOutput(0);
            }
        }
        
        function showInCanvas(svgString) {
            const content = document.getElementById('canvasContent');
            content.innerHTML = `<div class="svg-preview" id="svgPreview">${svgString}</div>`;
            
            // 調整縮放以適合視窗
            fitToWindow();
        }
        
        // ============================================
        // 縮放控制
        // ============================================
        function initToolbar() {
            document.getElementById('zoomInBtn').addEventListener('click', () => zoomIn());
            document.getElementById('zoomOutBtn').addEventListener('click', () => zoomOut());
            document.getElementById('zoomFitBtn').addEventListener('click', () => fitToWindow());
            
            // 復原/重做
            document.getElementById('undoBtn').addEventListener('click', () => undo());
            document.getElementById('redoBtn').addEventListener('click', () => redo());
            
            // 編輯工具按鈕
            document.getElementById('selectTool')?.addEventListener('click', () => activateTool('select'));
            document.getElementById('moveTool')?.addEventListener('click', () => activateTool('move'));
            document.getElementById('colorPickerTool')?.addEventListener('click', () => activateTool('colorPicker'));
            document.getElementById('eraserTool')?.addEventListener('click', () => activateTool('eraser'));
            
            // 畫布點擊事件（用於工具操作）
            initCanvasInteraction();
        }
        
        // 啟用工具
        function activateTool(tool) {
            AppState.currentTool = tool;
            
            // 更新按鈕狀態
            const toolButtons = {
                'select': 'selectTool',
                'move': 'moveTool', 
                'colorPicker': 'colorPickerTool',
                'eraser': 'eraserTool'
            };
            
            Object.entries(toolButtons).forEach(([t, btnId]) => {
                const btn = document.getElementById(btnId);
                if (btn) btn.classList.toggle('active', t === tool);
            });
            
            // 更新游標
            const canvas = document.getElementById('canvasContainer');
            if (canvas) {
                const cursors = {
                    'select': 'default',
                    'move': 'grab',
                    'colorPicker': 'crosshair',
                    'eraser': 'not-allowed'
                };
                canvas.style.cursor = cursors[tool] || 'default';
            }
            
            // 更新提示
            const toolNames = {
                'select': '選取工具 - 點擊圖層以選取',
                'move': '移動工具 - 拖曳移動元素',
                'colorPicker': '顏色選取器 - 點擊元素取色',
                'eraser': '橡皮擦 - 點擊刪除元素'
            };
            updateToolbarInfo(toolNames[tool] || '');
            showToast(toolNames[tool], 'info');
        }
        
        // 初始化畫布互動
        function initCanvasInteraction() {
            const canvas = document.getElementById('canvasContainer');
            if (!canvas) return;
            
            canvas.addEventListener('click', (e) => {
                const svgElement = e.target.closest('path, rect, circle, ellipse, polygon, polyline, line, text, g');
                if (!svgElement) return;
                
                const preview = document.getElementById('svgPreview');
                if (!preview) return;
                
                const svg = preview.querySelector('svg');
                if (!svg) return;
                
                const elements = svg.querySelectorAll('path, rect, circle, ellipse, polygon, polyline, line, text, g');
                const index = Array.from(elements).indexOf(svgElement);
                
                switch (AppState.currentTool) {
                    case 'select':
                        if (index >= 0) {
                            selectLayer(index);
                        }
                        break;
                        
                    case 'colorPicker':
                        const fill = svgElement.getAttribute('fill');
                        const stroke = svgElement.getAttribute('stroke');
                        
                        if (fill && fill !== 'none') {
                            const hexColor = colorToHex(fill);
                            document.getElementById('fillColorPicker').value = hexColor;
                            document.getElementById('fillHexInput').value = hexColor.toUpperCase();
                            updateFillSwatchSelection(hexColor);
                            showToast(`已取得填充顏色: ${hexColor}`, 'success');
                        } else if (stroke && stroke !== 'none') {
                            const hexColor = colorToHex(stroke);
                            document.getElementById('strokeColorPicker').value = hexColor;
                            document.getElementById('strokeHexInput').value = hexColor.toUpperCase();
                            updateStrokeSwatchSelection(hexColor);
                            showToast(`已取得描邊顏色: ${hexColor}`, 'success');
                        }
                        break;
                        
                    case 'eraser':
                        if (confirm('確定要刪除這個元素嗎？')) {
                            deleteElement(svgElement, index);
                        }
                        break;
                        
                    case 'move':
                        if (index >= 0) {
                            selectLayer(index);
                            showToast('已選取，可使用變換面板調整位置', 'info');
                            switchEditorTab('transform');
                        }
                        break;
                }
            });
        }
        
        // 顏色轉 Hex
        function colorToHex(color) {
            if (!color) return '#000000';
            if (color.startsWith('#')) {
                return color.length === 4 
                    ? `#${color[1]}${color[1]}${color[2]}${color[2]}${color[3]}${color[3]}`
                    : color;
            }
            
            // rgb() 格式
            const rgb = color.match(/\d+/g);
            if (rgb && rgb.length >= 3) {
                return '#' + rgb.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
            }
            
            // 顏色名稱對照
            const names = {
                black: '#000000', white: '#ffffff', red: '#ff0000', green: '#008000',
                blue: '#0000ff', yellow: '#ffff00', orange: '#ffa500', purple: '#800080',
                pink: '#ffc0cb', gray: '#808080', grey: '#808080'
            };
            return names[color.toLowerCase()] || '#000000';
        }
        
        // 刪除元素
        function deleteElement(element, index) {
            const currentOutput = AppState.outputs[AppState.currentPreviewIndex];
            if (!currentOutput || !currentOutput.svg) return;
            
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(currentOutput.svg, 'image/svg+xml');
            const svg = svgDoc.querySelector('svg');
            if (!svg) return;
            
            const elements = svg.querySelectorAll('path, rect, circle, ellipse, polygon, polyline, line, text, g');
            if (elements[index]) {
                elements[index].remove();
                
                const serializer = new XMLSerializer();
                const newSvgString = serializer.serializeToString(svg);
                currentOutput.svg = newSvgString;
                currentOutput.colors = extractColors(newSvgString);
                
                showInCanvas(newSvgString);
                renderLayers(newSvgString);
                renderExtractedColors(currentOutput.colors);
                
                AppState.selectedLayer = -1;
                showToast('元素已刪除', 'success');
                addToHistory('delete', `刪除元素 ${index + 1}`);
            }
        }
        
        function zoomIn() {
            AppState.zoom = Math.min(AppState.zoom * 1.2, 5);
            applyZoom();
        }
        
        function zoomOut() {
            AppState.zoom = Math.max(AppState.zoom / 1.2, 0.1);
            applyZoom();
        }
        
        function fitToWindow() {
            const container = document.getElementById('canvasContainer');
            const preview = document.getElementById('svgPreview');
            
            if (!preview) return;
            
            const containerRect = container.getBoundingClientRect();
            const svg = preview.querySelector('svg');
            
            if (svg) {
                const svgWidth = svg.viewBox?.baseVal?.width || svg.clientWidth || 500;
                const svgHeight = svg.viewBox?.baseVal?.height || svg.clientHeight || 500;
                
                const scaleX = (containerRect.width - 80) / svgWidth;
                const scaleY = (containerRect.height - 80) / svgHeight;
                
                AppState.zoom = Math.min(scaleX, scaleY, 1);
                applyZoom();
            }
        }
        
        function applyZoom() {
            const preview = document.getElementById('svgPreview');
            if (preview) {
                preview.style.transform = `scale(${AppState.zoom})`;
            }
            
            document.getElementById('zoomValue').textContent = Math.round(AppState.zoom * 100) + '%';
        }
        
        // ============================================
        // 圖層管理
        // ============================================
        function renderLayers(svgString) {
            const container = document.getElementById('layerList');
            
            // 解析 SVG 元素
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgString, 'image/svg+xml');
            const svg = svgDoc.querySelector('svg');
            
            if (!svg) {
                container.innerHTML = `
                    <div class="canvas-empty" style="padding: 24px;">
                        <div class="canvas-empty-icon" style="font-size: 2.5rem;">📑</div>
                        <div class="canvas-empty-desc" style="font-size: 0.8rem;">無法解析圖層</div>
                    </div>
                `;
                return;
            }
            
            const layers = [];
            const elements = svg.querySelectorAll('path, rect, circle, ellipse, polygon, polyline, line, g, text');
            
            elements.forEach((el, i) => {
                const fill = el.getAttribute('fill') || 'none';
                const id = el.getAttribute('id') || `element-${i + 1}`;
                const type = el.tagName.toLowerCase();
                
                layers.push({
                    index: i,
                    id: id,
                    type: type,
                    fill: fill,
                    visible: true,
                    element: el
                });
            });
            
            if (layers.length === 0) {
                container.innerHTML = `
                    <div class="canvas-empty" style="padding: 24px;">
                        <div class="canvas-empty-icon" style="font-size: 2.5rem;">📑</div>
                        <div class="canvas-empty-desc" style="font-size: 0.8rem;">尚無圖層</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = layers.map(layer => `
                <div class="layer-item ${AppState.selectedLayer === layer.index ? 'selected' : ''}" 
                     data-index="${layer.index}" 
                     onclick="selectLayer(${layer.index})">
                    <button class="layer-visibility ${!layer.visible ? 'hidden' : ''}" 
                            onclick="event.stopPropagation(); toggleLayerVisibility(${layer.index})">
                        ${layer.visible ? '👁️' : '👁️‍🗨️'}
                    </button>
                    <div class="layer-color" style="background: ${layer.fill === 'none' ? 'transparent' : layer.fill}; ${layer.fill === 'none' ? 'border: 1px dashed var(--border-color);' : ''}"></div>
                    <span class="layer-name">${escapeHtml(layer.id)}</span>
                    <span class="layer-type">${getLayerTypeName(layer.type)}</span>
                </div>
            `).join('');
        }
        
        function getLayerTypeName(type) {
            const names = {
                path: '路徑',
                rect: '矩形',
                circle: '圓形',
                ellipse: '橢圓',
                polygon: '多邊形',
                polyline: '折線',
                line: '線條',
                g: '群組',
                text: '文字'
            };
            return names[type] || type;
        }
        
        function selectLayer(index) {
            AppState.selectedLayer = index;
            renderLayers(AppState.outputs[AppState.currentPreviewIndex]?.svg || '');
            updateToolbarInfo(`已選取圖層 ${index + 1}`);
        }
        
        function toggleLayerVisibility(index) {
            // 取得當前 SVG
            const currentOutput = AppState.outputs[AppState.currentPreviewIndex];
            if (!currentOutput || !currentOutput.svg) return;
            
            // 解析 SVG
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(currentOutput.svg, 'image/svg+xml');
            const svg = svgDoc.querySelector('svg');
            if (!svg) return;
            
            // 取得所有可見元素
            const elements = svg.querySelectorAll('path, rect, circle, ellipse, polygon, polyline, line, g, text');
            const targetElement = elements[index];
            
            if (targetElement) {
                // 切換顯示狀態
                const currentDisplay = targetElement.getAttribute('display');
                if (currentDisplay === 'none') {
                    targetElement.removeAttribute('display');
                    showToast(`圖層 ${index + 1} 已顯示`, 'info');
                } else {
                    targetElement.setAttribute('display', 'none');
                    showToast(`圖層 ${index + 1} 已隱藏`, 'info');
                }
                
                // 序列化並更新
                const serializer = new XMLSerializer();
                const newSvgString = serializer.serializeToString(svg);
                currentOutput.svg = newSvgString;
                
                // 更新畫布和圖層列表
                showInCanvas(newSvgString);
                renderLayers(newSvgString);
                
                // 記錄歷史
                addToHistory('toggle_layer', `切換圖層 ${index + 1} 顯示狀態`);
            }
        }
        
        function updateToolbarInfo(text) {
            document.getElementById('toolbarInfo').textContent = text;
        }
        
        // ============================================
        // 編輯器標籤頁
        // ============================================
        function switchEditorTab(tab) {
            AppState.currentTab = tab;
            
            // 更新標籤狀態
            document.querySelectorAll('.editor-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            
            // 顯示對應面板
            document.getElementById('layersPanel').style.display = tab === 'layers' ? 'block' : 'none';
            document.getElementById('colorsPanel').style.display = tab === 'colors' ? 'block' : 'none';
            document.getElementById('transformPanel').style.display = tab === 'transform' ? 'block' : 'none';
            document.getElementById('historyPanel').style.display = tab === 'history' ? 'block' : 'none';
        }
        
        // ============================================
        // 顏色選擇器
        // ============================================
        function initColorPickers() {
            // 填充顏色
            const fillPicker = document.getElementById('fillColorPicker');
            const fillHex = document.getElementById('fillHexInput');
            
            fillPicker.addEventListener('input', (e) => {
                fillHex.value = e.target.value.toUpperCase();
                updateFillSwatchSelection(e.target.value);
            });
            
            fillHex.addEventListener('input', (e) => {
                const value = e.target.value;
                if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                    fillPicker.value = value;
                    updateFillSwatchSelection(value);
                }
            });
            
            // 填充色板點擊
            document.querySelectorAll('#fillPalette .color-swatch').forEach(swatch => {
                swatch.addEventListener('click', () => {
                    const color = swatch.dataset.color;
                    fillPicker.value = color;
                    fillHex.value = color.toUpperCase();
                    updateFillSwatchSelection(color);
                });
            });
            
            // 描邊顏色
            const strokePicker = document.getElementById('strokeColorPicker');
            const strokeHex = document.getElementById('strokeHexInput');
            
            strokePicker.addEventListener('input', (e) => {
                strokeHex.value = e.target.value.toUpperCase();
                updateStrokeSwatchSelection(e.target.value);
            });
            
            strokeHex.addEventListener('input', (e) => {
                const value = e.target.value;
                if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                    strokePicker.value = value;
                    updateStrokeSwatchSelection(value);
                }
            });
            
            // 描邊色板點擊
            document.querySelectorAll('#strokePalette .color-swatch').forEach(swatch => {
                swatch.addEventListener('click', () => {
                    const color = swatch.dataset.color;
                    strokePicker.value = color;
                    strokeHex.value = color.toUpperCase();
                    updateStrokeSwatchSelection(color);
                });
            });
        }
        
        function updateFillSwatchSelection(color) {
            document.querySelectorAll('#fillPalette .color-swatch').forEach(swatch => {
                swatch.classList.toggle('selected', swatch.dataset.color.toUpperCase() === color.toUpperCase());
            });
        }
        
        function updateStrokeSwatchSelection(color) {
            document.querySelectorAll('#strokePalette .color-swatch').forEach(swatch => {
                swatch.classList.toggle('selected', swatch.dataset.color.toUpperCase() === color.toUpperCase());
            });
        }
        
        // 套用填充顏色到選取的圖層
        function applyFillColor() {
            if (AppState.selectedLayer === null || AppState.selectedLayer < 0) {
                showToast('請先選取一個圖層', 'warning');
                return;
            }
            
            const currentOutput = AppState.outputs[AppState.currentPreviewIndex];
            if (!currentOutput || !currentOutput.svg) {
                showToast('沒有可編輯的 SVG', 'warning');
                return;
            }
            
            const color = document.getElementById('fillColorPicker').value;
            
            // 解析 SVG
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(currentOutput.svg, 'image/svg+xml');
            const svg = svgDoc.querySelector('svg');
            if (!svg) return;
            
            // 取得目標元素
            const elements = svg.querySelectorAll('path, rect, circle, ellipse, polygon, polyline, line, g, text');
            const targetElement = elements[AppState.selectedLayer];
            
            if (targetElement) {
                const oldColor = targetElement.getAttribute('fill') || 'none';
                targetElement.setAttribute('fill', color);
                
                // 序列化並更新
                const serializer = new XMLSerializer();
                const newSvgString = serializer.serializeToString(svg);
                currentOutput.svg = newSvgString;
                currentOutput.colors = extractColors(newSvgString);
                
                // 更新畫布和圖層列表
                showInCanvas(newSvgString);
                renderLayers(newSvgString);
                renderExtractedColors(currentOutput.colors);
                
                showToast(`已將填充顏色改為 ${color}`, 'success');
                addToHistory('change_fill', `圖層 ${AppState.selectedLayer + 1}: ${oldColor} → ${color}`);
            }
        }
        
        // 套用描邊顏色到選取的圖層
        function applyStrokeColor() {
            if (AppState.selectedLayer === null || AppState.selectedLayer < 0) {
                showToast('請先選取一個圖層', 'warning');
                return;
            }
            
            const currentOutput = AppState.outputs[AppState.currentPreviewIndex];
            if (!currentOutput || !currentOutput.svg) {
                showToast('沒有可編輯的 SVG', 'warning');
                return;
            }
            
            const color = document.getElementById('strokeColorPicker').value;
            
            // 解析 SVG
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(currentOutput.svg, 'image/svg+xml');
            const svg = svgDoc.querySelector('svg');
            if (!svg) return;
            
            // 取得目標元素
            const elements = svg.querySelectorAll('path, rect, circle, ellipse, polygon, polyline, line, g, text');
            const targetElement = elements[AppState.selectedLayer];
            
            if (targetElement) {
                const oldColor = targetElement.getAttribute('stroke') || 'none';
                targetElement.setAttribute('stroke', color);
                
                // 序列化並更新
                const serializer = new XMLSerializer();
                const newSvgString = serializer.serializeToString(svg);
                currentOutput.svg = newSvgString;
                
                // 更新畫布和圖層列表
                showInCanvas(newSvgString);
                renderLayers(newSvgString);
                
                showToast(`已將描邊顏色改為 ${color}`, 'success');
                addToHistory('change_stroke', `圖層 ${AppState.selectedLayer + 1}: ${oldColor} → ${color}`);
            }
        }
        
        // ============================================
        // 變換功能
        // ============================================
        function initTransform() {
            // 監聽 SVG 選取變化，更新變換面板數值
            const updateTransformInputs = () => {
                const currentOutput = AppState.outputs[AppState.currentPreviewIndex];
                if (!currentOutput || !currentOutput.svg) return;
                
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(currentOutput.svg, 'image/svg+xml');
                const svg = svgDoc.querySelector('svg');
                if (!svg) return;
                
                // 取得 viewBox 或 width/height
                const viewBox = svg.getAttribute('viewBox');
                let width = 0, height = 0;
                
                if (viewBox) {
                    const parts = viewBox.split(/\s+/);
                    width = parseFloat(parts[2]) || 0;
                    height = parseFloat(parts[3]) || 0;
                } else {
                    width = parseFloat(svg.getAttribute('width')) || 0;
                    height = parseFloat(svg.getAttribute('height')) || 0;
                }
                
                document.getElementById('transformWidth').value = Math.round(width);
                document.getElementById('transformHeight').value = Math.round(height);
            };
            
            // 在選取輸出時更新
            const origSelectOutput = window.selectOutput;
            window.selectOutput = function(index) {
                origSelectOutput(index);
                setTimeout(updateTransformInputs, 100);
            };
        }
        
        function applyTransform() {
            const currentOutput = AppState.outputs[AppState.currentPreviewIndex];
            if (!currentOutput || !currentOutput.svg) {
                showToast('沒有可編輯的 SVG', 'warning');
                return;
            }
            
            const width = parseInt(document.getElementById('transformWidth').value) || 0;
            const height = parseInt(document.getElementById('transformHeight').value) || 0;
            const rotation = parseInt(document.getElementById('transformRotation').value) || 0;
            const scale = parseInt(document.getElementById('transformScale').value) || 100;
            
            if (width <= 0 || height <= 0) {
                showToast('請輸入有效的寬度和高度', 'warning');
                return;
            }
            
            // 解析 SVG
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(currentOutput.svg, 'image/svg+xml');
            const svg = svgDoc.querySelector('svg');
            if (!svg) return;
            
            // 取得原始尺寸
            const viewBox = svg.getAttribute('viewBox');
            let origWidth, origHeight;
            if (viewBox) {
                const parts = viewBox.split(/\s+/);
                origWidth = parseFloat(parts[2]) || width;
                origHeight = parseFloat(parts[3]) || height;
            } else {
                origWidth = parseFloat(svg.getAttribute('width')) || width;
                origHeight = parseFloat(svg.getAttribute('height')) || height;
            }
            
            // 計算縮放比例
            const scaleRatio = scale / 100;
            const newWidth = width * scaleRatio;
            const newHeight = height * scaleRatio;
            
            // 更新 SVG 屬性
            svg.setAttribute('width', newWidth);
            svg.setAttribute('height', newHeight);
            svg.setAttribute('viewBox', `0 0 ${origWidth} ${origHeight}`);
            
            // 如果有旋轉，加入 transform
            if (rotation !== 0) {
                const centerX = origWidth / 2;
                const centerY = origHeight / 2;
                
                // 找到或建立根群組
                let rootG = svg.querySelector('g#transform-root');
                if (!rootG) {
                    rootG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    rootG.setAttribute('id', 'transform-root');
                    
                    // 將所有子元素移到群組中
                    while (svg.firstChild) {
                        rootG.appendChild(svg.firstChild);
                    }
                    svg.appendChild(rootG);
                }
                
                rootG.setAttribute('transform', `rotate(${rotation} ${centerX} ${centerY})`);
            }
            
            // 序列化並更新
            const serializer = new XMLSerializer();
            const newSvgString = serializer.serializeToString(svg);
            currentOutput.svg = newSvgString;
            
            // 更新畫布
            showInCanvas(newSvgString);
            renderOutputs();
            
            showToast(`已套用變換: ${newWidth}×${newHeight}, 旋轉 ${rotation}°`, 'success');
            addToHistory('transform', `尺寸: ${newWidth}×${newHeight}, 旋轉: ${rotation}°`);
        }
        
        // ============================================
        // 歷史記錄
        // ============================================
        function addToHistory(action, detail = '') {
            const record = {
                action: action,
                detail: detail,
                time: new Date().toLocaleTimeString(),
                state: JSON.stringify(AppState.outputs)
            };
            
            // 如果不在最新位置，移除後面的記錄
            if (AppState.historyIndex < AppState.history.length - 1) {
                AppState.history = AppState.history.slice(0, AppState.historyIndex + 1);
            }
            
            AppState.history.push(record);
            
            // 限制歷史記錄數量
            if (AppState.history.length > AppState.maxHistory) {
                AppState.history.shift();
            }
            
            AppState.historyIndex = AppState.history.length - 1;
            
            renderHistory();
            updateUndoRedoButtons();
        }
        
        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (AppState.history.length === 0) {
                container.innerHTML = `
                    <div class="canvas-empty" style="padding: 24px;">
                        <div class="canvas-empty-icon" style="font-size: 2.5rem;">📜</div>
                        <div class="canvas-empty-desc" style="font-size: 0.8rem;">尚無操作記錄</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = AppState.history.map((record, i) => {
                let className = 'history-item';
                if (i === AppState.historyIndex) className += ' current';
                if (i > AppState.historyIndex) className += ' future';
                
                return `
                    <div class="${className}" onclick="goToHistory(${i})">
                        <span class="history-icon">${getHistoryIcon(record.action)}</span>
                        <span class="history-text">${escapeHtml(record.action)}${record.detail ? ` - ${escapeHtml(record.detail)}` : ''}</span>
                        <span class="history-time">${record.time}</span>
                    </div>
                `;
            }).join('');
        }
        
        function getHistoryIcon(action) {
            if (action.includes('轉換')) return '⚗️';
            if (action.includes('顏色')) return '🎨';
            if (action.includes('變換')) return '📐';
            if (action.includes('刪除')) return '🗑️';
            return '📝';
        }
        
        function goToHistory(index) {
            if (index < 0 || index >= AppState.history.length) return;
            
            AppState.historyIndex = index;
            
            // 還原狀態
            try {
                AppState.outputs = JSON.parse(AppState.history[index].state);
                renderOutputs();
                if (AppState.outputs.length > 0) {
                    showInCanvas(AppState.outputs[AppState.currentPreviewIndex]?.svg || AppState.outputs[0].svg);
                }
            } catch (e) {
                console.error('還原歷史狀態失敗:', e);
            }
            
            renderHistory();
            updateUndoRedoButtons();
        }
        
        function undo() {
            if (AppState.historyIndex > 0) {
                goToHistory(AppState.historyIndex - 1);
                showToast('已復原', 'info');
            }
        }
        
        function redo() {
            if (AppState.historyIndex < AppState.history.length - 1) {
                goToHistory(AppState.historyIndex + 1);
                showToast('已重做', 'info');
            }
        }
        
        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = AppState.historyIndex <= 0;
            document.getElementById('redoBtn').disabled = AppState.historyIndex >= AppState.history.length - 1;
        }
        
        // ============================================
        // 鍵盤快捷鍵
        // ============================================
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd 組合鍵
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key.toLowerCase()) {
                        case 'z':
                            e.preventDefault();
                            undo();
                            break;
                        case 'y':
                            e.preventDefault();
                            redo();
                            break;
                        case 's':
                            e.preventDefault();
                            if (AppState.outputs.length > 0) {
                                downloadCurrentSVG();
                            }
                            break;
                        case 'e':
                            e.preventDefault();
                            if (AppState.outputs.length > 0) {
                                document.getElementById('exportModal').classList.add('show');
                            }
                            break;
                        case 'o':
                            e.preventDefault();
                            document.getElementById('fileInput').click();
                            break;
                        case '=':
                        case '+':
                            e.preventDefault();
                            zoomIn();
                            break;
                        case '-':
                            e.preventDefault();
                            zoomOut();
                            break;
                        case '0':
                            e.preventDefault();
                            fitToWindow();
                            break;
                    }
                }
                
                // 單鍵快捷鍵
                if (!e.ctrlKey && !e.metaKey && !e.altKey) {
                    // 只在沒有聚焦輸入框時生效
                    if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    switch (e.key.toLowerCase()) {
                        case 'v':
                            // 選取工具
                            break;
                        case 'm':
                            // 移動工具
                            break;
                        case 'i':
                            // 顏色選取器
                            break;
                        case 'e':
                            // 橡皮擦
                            break;
                        case 'delete':
                        case 'backspace':
                            // 刪除選取
                            break;
                        case 'escape':
                            closeAllModals();
                            break;
                        case '?':
                            document.getElementById('shortcutsModal').classList.add('show');
                            break;
                    }
                }
            });
        }
        
        // ============================================
        // 預覽 Modal
        // ============================================
        function openPreview(index) {
            AppState.currentPreviewIndex = index;
            const output = AppState.outputs[index];
            
            if (!output) return;
            
            document.getElementById('previewTitle').textContent = output.name;
            document.getElementById('previewBody').innerHTML = output.svg;
            document.getElementById('previewModal').classList.add('show');
        }
        
        function closePreview() {
            document.getElementById('previewModal').classList.remove('show');
        }
        
        // ============================================
        // 下載功能
        // ============================================
        function downloadSVG(index) {
            const output = AppState.outputs[index];
            if (!output) return;
            
            downloadFile(output.svg, output.name, 'image/svg+xml');
            showToast(`已下載 ${output.name}`, 'success');
        }
        
        function downloadPNG(index) {
            const output = AppState.outputs[index];
            if (!output) return;
            
            svgToPNG(output.svg, (dataUrl) => {
                const link = document.createElement('a');
                link.download = output.name.replace('.svg', '.png');
                link.href = dataUrl;
                link.click();
                showToast(`已下載 ${output.name.replace('.svg', '.png')}`, 'success');
            });
        }
        
        function downloadCurrentSVG() {
            if (AppState.currentPreviewIndex >= 0) {
                downloadSVG(AppState.currentPreviewIndex);
            } else if (AppState.outputs.length > 0) {
                downloadSVG(0);
            }
        }
        
        function downloadCurrentPNG() {
            if (AppState.currentPreviewIndex >= 0) {
                downloadPNG(AppState.currentPreviewIndex);
            } else if (AppState.outputs.length > 0) {
                downloadPNG(0);
            }
        }
        
        function copyCurrentSVG() {
            const index = AppState.currentPreviewIndex >= 0 ? AppState.currentPreviewIndex : 0;
            const output = AppState.outputs[index];
            
            if (output) {
                navigator.clipboard.writeText(output.svg);
                showToast('SVG 代碼已複製到剪貼簿', 'success');
            }
        }
        
        async function downloadAllSVG() {
            if (AppState.outputs.length === 0) return;
            
            if (AppState.outputs.length === 1) {
                downloadSVG(0);
                return;
            }
            
            // 使用 JSZip 打包下載
            const zip = new JSZip();
            
            AppState.outputs.forEach(output => {
                zip.file(output.name, output.svg);
            });
            
            const content = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(content);
            const link = document.createElement('a');
            link.download = 'vector-alchemy-outputs.zip';
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            
            showToast(`已下載 ${AppState.outputs.length} 個 SVG 檔案`, 'success');
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function svgToPNG(svgString, callback, width, height) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            // 解析 SVG 尺寸
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgString, 'image/svg+xml');
            const svgEl = svgDoc.querySelector('svg');
            
            let svgWidth = width || parseInt(svgEl?.getAttribute('width')) || 800;
            let svgHeight = height || parseInt(svgEl?.getAttribute('height')) || 600;
            
            const viewBox = svgEl?.getAttribute('viewBox');
            if (viewBox && !width) {
                const parts = viewBox.split(/\s+/);
                if (parts.length >= 4) {
                    svgWidth = parseInt(parts[2]) || svgWidth;
                    svgHeight = parseInt(parts[3]) || svgHeight;
                }
            }
            
            const scale = 2; // 高解析度
            canvas.width = svgWidth * scale;
            canvas.height = svgHeight * scale;
            
            const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);
            
            img.onload = () => {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                callback(canvas.toDataURL('image/png'));
                URL.revokeObjectURL(url);
            };
            
            img.onerror = () => {
                console.error('PNG 轉換失敗');
                URL.revokeObjectURL(url);
            };
            
            img.src = url;
        }
        
        // ============================================
        // 導出 Modal
        // ============================================
        function selectExportFormat(format) {
            document.querySelectorAll('.export-format-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.format === format);
            });
            
            // SVG 不需要尺寸設定
            document.getElementById('exportSizeSection').style.display = format === 'svg' ? 'none' : 'block';
        }
        
        function setExportPreset(width, height) {
            document.getElementById('exportWidth').value = width;
            document.getElementById('exportHeight').value = height;
        }
        
        function executeExport() {
            const format = document.querySelector('.export-format-btn.selected')?.dataset.format || 'svg';
            const width = parseInt(document.getElementById('exportWidth').value) || 1024;
            const height = parseInt(document.getElementById('exportHeight').value) || 1024;
            
            if (AppState.outputs.length === 0) {
                showToast('沒有可導出的內容', 'warning');
                return;
            }
            
            closeExportModal();
            
            if (format === 'svg') {
                downloadAllSVG();
            } else {
                // PNG/JPG 導出
                AppState.outputs.forEach((output, i) => {
                    setTimeout(() => {
                        svgToPNG(output.svg, (dataUrl) => {
                            const link = document.createElement('a');
                            link.download = output.name.replace('.svg', `.${format}`);
                            link.href = dataUrl;
                            link.click();
                        }, width, height);
                    }, i * 300);
                });
                
                showToast(`正在導出 ${AppState.outputs.length} 個 ${format.toUpperCase()} 檔案`, 'info');
            }
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }
        
        // ============================================
        // 設定 Modal
        // ============================================
        function initSettings() {
            // 深色模式
            document.getElementById('darkModeToggle').addEventListener('change', (e) => {
                AppState.settings.darkMode = e.target.checked;
                document.body.dataset.theme = e.target.checked ? 'dark' : 'light';
                document.getElementById('themeToggle').textContent = e.target.checked ? '🌙' : '☀️';
            });
            
            // 主題切換按鈕
            document.getElementById('themeToggle').addEventListener('click', () => {
                const toggle = document.getElementById('darkModeToggle');
                toggle.checked = !toggle.checked;
                toggle.dispatchEvent(new Event('change'));
            });
            
            // 動畫效果
            document.getElementById('animationToggle').addEventListener('change', (e) => {
                AppState.settings.animations = e.target.checked;
                document.getElementById('alchemyBg').style.display = e.target.checked ? 'block' : 'none';
            });
            
            // 打開設定
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.add('show');
            });
            
            // 打開快捷鍵
            document.getElementById('shortcutsBtn').addEventListener('click', () => {
                document.getElementById('shortcutsModal').classList.add('show');
            });
            
            // 打開教學
            document.getElementById('tutorialBtn').addEventListener('click', () => {
                showTutorial();
            });
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }
        
        function closeShortcutsModal() {
            document.getElementById('shortcutsModal').classList.remove('show');
        }
        
        function closeAllModals() {
            document.getElementById('previewModal').classList.remove('show');
            document.getElementById('exportModal').classList.remove('show');
            document.getElementById('settingsModal').classList.remove('show');
            document.getElementById('shortcutsModal').classList.remove('show');
            document.getElementById('tutorialOverlay').classList.remove('show');
        }
        
        // ============================================
        // 確認對話框
        // ============================================
        const ConfirmDialog = {
            show: function(options) {
                const { icon, title, message, onConfirm, onCancel, danger } = options;
                
                let dialog = document.getElementById('confirmDialog');
                if (!dialog) {
                    dialog = document.createElement('div');
                    dialog.id = 'confirmDialog';
                    dialog.className = 'confirm-dialog';
                    document.body.appendChild(dialog);
                }
                
                dialog.innerHTML = `
                    <div class="confirm-content">
                        <div class="confirm-icon">${icon || '❓'}</div>
                        <div class="confirm-title">${title || '確認'}</div>
                        <div class="confirm-message">${message || '確定要執行此操作嗎？'}</div>
                        <div class="confirm-actions">
                            <button class="confirm-btn confirm-btn-cancel" onclick="ConfirmDialog.cancel()">取消</button>
                            <button class="confirm-btn ${danger ? 'confirm-btn-danger' : 'confirm-btn-confirm'}" onclick="ConfirmDialog.confirm()">確定</button>
                        </div>
                    </div>
                `;
                
                this.onConfirm = onConfirm;
                this.onCancel = onCancel;
                
                dialog.classList.add('show');
            },
            
            confirm: function() {
                if (this.onConfirm) this.onConfirm();
                this.close();
            },
            
            cancel: function() {
                if (this.onCancel) this.onCancel();
                this.close();
            },
            
            close: function() {
                const dialog = document.getElementById('confirmDialog');
                if (dialog) dialog.classList.remove('show');
            }
        };
        
        // ============================================
        // 顏色工具函數
        // ============================================
        const ColorUtils = {
            // HEX 轉 RGB
            hexToRgb: function(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            },
            
            // RGB 轉 HEX
            rgbToHex: function(r, g, b) {
                return '#' + [r, g, b].map(x => {
                    const hex = x.toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                }).join('');
            },
            
            // RGB 轉 HSL
            rgbToHsl: function(r, g, b) {
                r /= 255; g /= 255; b /= 255;
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;
                
                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                        case g: h = ((b - r) / d + 2) / 6; break;
                        case b: h = ((r - g) / d + 4) / 6; break;
                    }
                }
                
                return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
            },
            
            // HSL 轉 RGB
            hslToRgb: function(h, s, l) {
                h /= 360; s /= 100; l /= 100;
                let r, g, b;
                
                if (s === 0) {
                    r = g = b = l;
                } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    };
                    
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                
                return {
                    r: Math.round(r * 255),
                    g: Math.round(g * 255),
                    b: Math.round(b * 255)
                };
            },
            
            // 計算對比色
            getContrastColor: function(hex) {
                const rgb = this.hexToRgb(hex);
                if (!rgb) return '#ffffff';
                
                const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
                return luminance > 0.5 ? '#000000' : '#ffffff';
            },
            
            // 調亮顏色
            lighten: function(hex, percent) {
                const rgb = this.hexToRgb(hex);
                if (!rgb) return hex;
                
                const hsl = this.rgbToHsl(rgb.r, rgb.g, rgb.b);
                hsl.l = Math.min(100, hsl.l + percent);
                const newRgb = this.hslToRgb(hsl.h, hsl.s, hsl.l);
                
                return this.rgbToHex(newRgb.r, newRgb.g, newRgb.b);
            },
            
            // 調暗顏色
            darken: function(hex, percent) {
                const rgb = this.hexToRgb(hex);
                if (!rgb) return hex;
                
                const hsl = this.rgbToHsl(rgb.r, rgb.g, rgb.b);
                hsl.l = Math.max(0, hsl.l - percent);
                const newRgb = this.hslToRgb(hsl.h, hsl.s, hsl.l);
                
                return this.rgbToHex(newRgb.r, newRgb.g, newRgb.b);
            },
            
            // 生成調色板
            generatePalette: function(hex, count = 5) {
                const palette = [];
                const step = 100 / (count + 1);
                
                for (let i = 1; i <= count; i++) {
                    const lightness = step * i;
                    const rgb = this.hexToRgb(hex);
                    if (rgb) {
                        const hsl = this.rgbToHsl(rgb.r, rgb.g, rgb.b);
                        hsl.l = lightness;
                        const newRgb = this.hslToRgb(hsl.h, hsl.s, hsl.l);
                        palette.push(this.rgbToHex(newRgb.r, newRgb.g, newRgb.b));
                    }
                }
                
                return palette;
            }
        };
        
        // ============================================
        // SVG 工具函數
        // ============================================
        const SVGUtils = {
            // 解析 SVG
            parse: function(svgString) {
                const parser = new DOMParser();
                return parser.parseFromString(svgString, 'image/svg+xml');
            },
            
            // 序列化 SVG
            serialize: function(svgElement) {
                const serializer = new XMLSerializer();
                return serializer.serializeToString(svgElement);
            },
            
            // 取得 viewBox
            getViewBox: function(svgString) {
                const doc = this.parse(svgString);
                const svg = doc.querySelector('svg');
                const viewBox = svg?.getAttribute('viewBox');
                
                if (viewBox) {
                    const parts = viewBox.split(/\s+/).map(Number);
                    return { x: parts[0], y: parts[1], width: parts[2], height: parts[3] };
                }
                
                return {
                    x: 0,
                    y: 0,
                    width: parseInt(svg?.getAttribute('width')) || 100,
                    height: parseInt(svg?.getAttribute('height')) || 100
                };
            },
            
            // 取得所有元素
            getElements: function(svgString) {
                const doc = this.parse(svgString);
                const svg = doc.querySelector('svg');
                return svg ? Array.from(svg.querySelectorAll('*')) : [];
            },
            
            // 取得路徑元素
            getPaths: function(svgString) {
                const doc = this.parse(svgString);
                const svg = doc.querySelector('svg');
                return svg ? Array.from(svg.querySelectorAll('path')) : [];
            },
            
            // 修改元素屬性
            modifyElement: function(svgString, selector, attributes) {
                const doc = this.parse(svgString);
                const svg = doc.querySelector('svg');
                const element = svg?.querySelector(selector);
                
                if (element) {
                    Object.entries(attributes).forEach(([key, value]) => {
                        element.setAttribute(key, value);
                    });
                }
                
                return this.serialize(svg);
            },
            
            // 刪除元素
            removeElement: function(svgString, selector) {
                const doc = this.parse(svgString);
                const svg = doc.querySelector('svg');
                const element = svg?.querySelector(selector);
                
                if (element) {
                    element.remove();
                }
                
                return this.serialize(svg);
            },
            
            // 優化 SVG
            optimize: function(svgString) {
                return svgString
                    .replace(/<!--[\s\S]*?-->/g, '')
                    .replace(/\s+/g, ' ')
                    .replace(/>\s+</g, '><')
                    .replace(/(\d+\.\d{3})\d+/g, '$1')
                    .replace(/\s+[a-z-]+=""/gi, '')
                    .trim();
            },
            
            // 計算檔案大小
            getFileSize: function(svgString) {
                const bytes = new Blob([svgString]).size;
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }
        };
        
        // ============================================
        // 圖片工具函數
        // ============================================
        const ImageUtils = {
            // 調整圖片大小
            resize: function(imageData, maxWidth, maxHeight) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        let { width, height } = img;
                        
                        if (width > maxWidth) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        }
                        
                        if (height > maxHeight) {
                            width = width * (maxHeight / height);
                            height = maxHeight;
                        }
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.src = imageData;
                });
            },
            
            // 裁剪圖片
            crop: function(imageData, x, y, width, height) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, x, y, width, height, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.src = imageData;
                });
            },
            
            // 旋轉圖片
            rotate: function(imageData, degrees) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const radians = degrees * Math.PI / 180;
                        const sin = Math.abs(Math.sin(radians));
                        const cos = Math.abs(Math.cos(radians));
                        
                        canvas.width = img.width * cos + img.height * sin;
                        canvas.height = img.width * sin + img.height * cos;
                        
                        ctx.translate(canvas.width / 2, canvas.height / 2);
                        ctx.rotate(radians);
                        ctx.drawImage(img, -img.width / 2, -img.height / 2);
                        
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.src = imageData;
                });
            },
            
            // 翻轉圖片
            flip: function(imageData, horizontal = true) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        const ctx = canvas.getContext('2d');
                        if (horizontal) {
                            ctx.scale(-1, 1);
                            ctx.drawImage(img, -img.width, 0);
                        } else {
                            ctx.scale(1, -1);
                            ctx.drawImage(img, 0, -img.height);
                        }
                        
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.src = imageData;
                });
            },
            
            // 灰階
            grayscale: function(imageData) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                            data[i] = data[i + 1] = data[i + 2] = avg;
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.src = imageData;
                });
            },
            
            // 提取主要顏色
            extractDominantColors: function(imageData, colorCount = 5) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const size = 50; // 縮小以提高效能
                        canvas.width = size;
                        canvas.height = size;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, size, size);
                        
                        const imageData = ctx.getImageData(0, 0, size, size);
                        const data = imageData.data;
                        const colorMap = {};
                        
                        for (let i = 0; i < data.length; i += 4) {
                            // 量化顏色
                            const r = Math.round(data[i] / 32) * 32;
                            const g = Math.round(data[i + 1] / 32) * 32;
                            const b = Math.round(data[i + 2] / 32) * 32;
                            const key = `${r},${g},${b}`;
                            
                            colorMap[key] = (colorMap[key] || 0) + 1;
                        }
                        
                        const sortedColors = Object.entries(colorMap)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, colorCount)
                            .map(([key]) => {
                                const [r, g, b] = key.split(',').map(Number);
                                return ColorUtils.rgbToHex(r, g, b);
                            });
                        
                        resolve(sortedColors);
                    };
                    img.src = imageData;
                });
            }
        };
        
        // ============================================
        // 動畫工具
        // ============================================
        const AnimationUtils = {
            // 緩動函數
            easing: {
                linear: t => t,
                easeInQuad: t => t * t,
                easeOutQuad: t => t * (2 - t),
                easeInOutQuad: t => t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t,
                easeInCubic: t => t * t * t,
                easeOutCubic: t => (--t) * t * t + 1,
                easeInOutCubic: t => t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1,
                easeInElastic: t => t === 0 ? 0 : t === 1 ? 1 : -Math.pow(2, 10 * t - 10) * Math.sin((t * 10 - 10.75) * (2 * Math.PI / 3)),
                easeOutElastic: t => t === 0 ? 0 : t === 1 ? 1 : Math.pow(2, -10 * t) * Math.sin((t * 10 - 0.75) * (2 * Math.PI / 3)) + 1,
                easeOutBounce: t => {
                    const n1 = 7.5625, d1 = 2.75;
                    if (t < 1 / d1) return n1 * t * t;
                    if (t < 2 / d1) return n1 * (t -= 1.5 / d1) * t + 0.75;
                    if (t < 2.5 / d1) return n1 * (t -= 2.25 / d1) * t + 0.9375;
                    return n1 * (t -= 2.625 / d1) * t + 0.984375;
                }
            },
            
            // 動畫執行
            animate: function(options) {
                const { from, to, duration, easing = 'easeOutQuad', onUpdate, onComplete } = options;
                const startTime = performance.now();
                const easingFn = this.easing[easing] || this.easing.linear;
                
                const tick = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easedProgress = easingFn(progress);
                    
                    const currentValue = from + (to - from) * easedProgress;
                    
                    if (onUpdate) onUpdate(currentValue, progress);
                    
                    if (progress < 1) {
                        requestAnimationFrame(tick);
                    } else if (onComplete) {
                        onComplete();
                    }
                };
                
                requestAnimationFrame(tick);
            },
            
            // 數值動畫
            countUp: function(element, target, duration = 1000) {
                const start = parseInt(element.textContent) || 0;
                this.animate({
                    from: start,
                    to: target,
                    duration,
                    onUpdate: (value) => {
                        element.textContent = Math.round(value);
                    }
                });
            }
        };
        
        // ============================================
        // 儲存工具
        // ============================================
        const StorageUtils = {
            // 注意：不儲存敏感資訊如 API Key
            
            save: function(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.warn('儲存失敗:', e);
                    return false;
                }
            },
            
            load: function(key, defaultValue = null) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (e) {
                    console.warn('讀取失敗:', e);
                    return defaultValue;
                }
            },
            
            remove: function(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    return false;
                }
            },
            
            clear: function() {
                try {
                    localStorage.clear();
                    return true;
                } catch (e) {
                    return false;
                }
            }
        };
        
        // ============================================
        // 全域拖放處理
        // ============================================
        document.addEventListener('dragenter', (e) => {
            e.preventDefault();
            if (e.dataTransfer.types.includes('Files')) {
                let indicator = document.getElementById('dropIndicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'dropIndicator';
                    indicator.className = 'drop-indicator';
                    indicator.innerHTML = `
                        <div class="drop-indicator-content">
                            <div class="drop-indicator-icon">📥</div>
                            <div class="drop-indicator-text">放開以上傳檔案</div>
                        </div>
                    `;
                    document.body.appendChild(indicator);
                }
                indicator.classList.add('show');
            }
        });
        
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
        });
        
        document.addEventListener('dragleave', (e) => {
            if (e.target === document || e.target === document.body) {
                const indicator = document.getElementById('dropIndicator');
                if (indicator) indicator.classList.remove('show');
            }
        });
        
        document.addEventListener('drop', (e) => {
            e.preventDefault();
            const indicator = document.getElementById('dropIndicator');
            if (indicator) indicator.classList.remove('show');
            
            if (e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        });
        
        // ============================================
        // 浮水印功能
        // ============================================
        const Watermark = {
            settings: {
                enabled: false,
                text: '',
                imageUrl: '',
                position: 'bottom-right', // top-left, top-right, bottom-left, bottom-right, center
                opacity: 0.3,
                fontSize: 24,
                color: '#888888',
                rotation: 0,
                margin: 20
            },
            
            // 應用浮水印到 SVG
            applyToSVG: function(svgString) {
                if (!this.settings.enabled || (!this.settings.text && !this.settings.imageUrl)) {
                    return svgString;
                }
                
                const doc = SVGUtils.parse(svgString);
                const svg = doc.querySelector('svg');
                if (!svg) return svgString;
                
                const viewBox = SVGUtils.getViewBox(svgString);
                
                // 計算位置
                const pos = this.calculatePosition(viewBox);
                
                // 創建浮水印群組
                const watermarkGroup = doc.createElementNS('http://www.w3.org/2000/svg', 'g');
                watermarkGroup.setAttribute('id', 'watermark');
                watermarkGroup.setAttribute('opacity', this.settings.opacity);
                watermarkGroup.setAttribute('transform', `rotate(${this.settings.rotation}, ${pos.x}, ${pos.y})`);
                
                if (this.settings.text) {
                    const text = doc.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', pos.x);
                    text.setAttribute('y', pos.y);
                    text.setAttribute('font-size', this.settings.fontSize);
                    text.setAttribute('fill', this.settings.color);
                    text.setAttribute('text-anchor', this.getTextAnchor());
                    text.textContent = this.settings.text;
                    watermarkGroup.appendChild(text);
                }
                
                svg.appendChild(watermarkGroup);
                
                return SVGUtils.serialize(svg);
            },
            
            calculatePosition: function(viewBox) {
                const margin = this.settings.margin;
                const positions = {
                    'top-left': { x: margin, y: margin + this.settings.fontSize },
                    'top-right': { x: viewBox.width - margin, y: margin + this.settings.fontSize },
                    'bottom-left': { x: margin, y: viewBox.height - margin },
                    'bottom-right': { x: viewBox.width - margin, y: viewBox.height - margin },
                    'center': { x: viewBox.width / 2, y: viewBox.height / 2 }
                };
                return positions[this.settings.position] || positions['bottom-right'];
            },
            
            getTextAnchor: function() {
                if (this.settings.position.includes('left')) return 'start';
                if (this.settings.position.includes('right')) return 'end';
                return 'middle';
            },
            
            // 顯示浮水印設定 Modal
            showSettings: function() {
                let modal = document.getElementById('watermarkModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'watermarkModal';
                    modal.className = 'settings-modal';
                    modal.innerHTML = `
                        <div class="settings-container" style="max-width: 450px;">
                            <div class="settings-header">
                                <span class="settings-title">💧 浮水印設定</span>
                                <button class="preview-close" onclick="Watermark.hideSettings()">✕</button>
                            </div>
                            <div class="settings-body">
                                <div class="settings-group">
                                    <div class="settings-row">
                                        <div>
                                            <div class="settings-label">啟用浮水印</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="watermarkEnabled" ${this.settings.enabled ? 'checked' : ''}>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">浮水印文字</label>
                                    <input type="text" class="form-input" id="watermarkText" value="${this.settings.text}" placeholder="例如：© 2024 Your Name">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">位置</label>
                                    <select class="form-input form-select" id="watermarkPosition">
                                        <option value="top-left" ${this.settings.position === 'top-left' ? 'selected' : ''}>左上</option>
                                        <option value="top-right" ${this.settings.position === 'top-right' ? 'selected' : ''}>右上</option>
                                        <option value="bottom-left" ${this.settings.position === 'bottom-left' ? 'selected' : ''}>左下</option>
                                        <option value="bottom-right" ${this.settings.position === 'bottom-right' ? 'selected' : ''}>右下</option>
                                        <option value="center" ${this.settings.position === 'center' ? 'selected' : ''}>中央</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">透明度: <span id="opacityValue">${Math.round(this.settings.opacity * 100)}%</span></label>
                                    <input type="range" class="range-slider" id="watermarkOpacity" min="10" max="100" value="${this.settings.opacity * 100}">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">字體大小</label>
                                    <input type="number" class="form-input" id="watermarkFontSize" value="${this.settings.fontSize}" min="8" max="72">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">顏色</label>
                                    <div class="color-custom">
                                        <div class="color-picker-wrapper">
                                            <input type="color" class="color-picker" id="watermarkColor" value="${this.settings.color}">
                                        </div>
                                        <input type="text" class="color-hex-input" id="watermarkColorHex" value="${this.settings.color}">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">旋轉角度</label>
                                    <input type="number" class="form-input" id="watermarkRotation" value="${this.settings.rotation}" min="-180" max="180">
                                </div>
                            </div>
                            <div class="export-footer">
                                <button class="preview-btn" onclick="Watermark.hideSettings()">取消</button>
                                <button class="preview-btn primary" onclick="Watermark.saveSettings()">儲存</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // 透明度滑桿事件
                    document.getElementById('watermarkOpacity').addEventListener('input', (e) => {
                        document.getElementById('opacityValue').textContent = e.target.value + '%';
                    });
                }
                
                modal.classList.add('show');
            },
            
            hideSettings: function() {
                const modal = document.getElementById('watermarkModal');
                if (modal) modal.classList.remove('show');
            },
            
            saveSettings: function() {
                this.settings.enabled = document.getElementById('watermarkEnabled').checked;
                this.settings.text = document.getElementById('watermarkText').value;
                this.settings.position = document.getElementById('watermarkPosition').value;
                this.settings.opacity = parseInt(document.getElementById('watermarkOpacity').value) / 100;
                this.settings.fontSize = parseInt(document.getElementById('watermarkFontSize').value);
                this.settings.color = document.getElementById('watermarkColor').value;
                this.settings.rotation = parseInt(document.getElementById('watermarkRotation').value);
                
                this.hideSettings();
                showToast('浮水印設定已儲存', 'success');
            }
        };
        
        // ============================================
        // 批次處理佇列
        // ============================================
        const BatchQueue = {
            queue: [],
            isProcessing: false,
            currentIndex: 0,
            
            add: function(task) {
                this.queue.push({
                    id: Date.now() + Math.random(),
                    ...task,
                    status: 'pending'
                });
                this.renderQueue();
            },
            
            remove: function(id) {
                this.queue = this.queue.filter(t => t.id !== id);
                this.renderQueue();
            },
            
            clear: function() {
                this.queue = [];
                this.renderQueue();
            },
            
            start: async function() {
                if (this.isProcessing || this.queue.length === 0) return;
                
                this.isProcessing = true;
                this.currentIndex = 0;
                
                for (const task of this.queue) {
                    if (task.status === 'pending') {
                        task.status = 'processing';
                        this.renderQueue();
                        
                        try {
                            await task.execute();
                            task.status = 'completed';
                        } catch (e) {
                            task.status = 'error';
                            task.error = e.message;
                        }
                        
                        this.currentIndex++;
                        this.renderQueue();
                    }
                }
                
                this.isProcessing = false;
                showToast('批次處理完成', 'success');
            },
            
            pause: function() {
                this.isProcessing = false;
            },
            
            renderQueue: function() {
                // 這裡可以渲染佇列 UI
                console.log('批次佇列:', this.queue);
            },
            
            getProgress: function() {
                const completed = this.queue.filter(t => t.status === 'completed').length;
                return {
                    total: this.queue.length,
                    completed: completed,
                    percent: this.queue.length > 0 ? (completed / this.queue.length) * 100 : 0
                };
            }
        };
        
        // ============================================
        // 統計面板
        // ============================================
        const Statistics = {
            data: {
                totalConverted: 0,
                totalSize: 0,
                averageTime: 0,
                conversionTimes: [],
                formatBreakdown: {
                    pdf: 0,
                    image: 0
                },
                styleBreakdown: {
                    clean: 0,
                    outline: 0,
                    gradient: 0,
                    sketch: 0
                }
            },
            
            record: function(type, style, size, time) {
                this.data.totalConverted++;
                this.data.totalSize += size;
                this.data.conversionTimes.push(time);
                this.data.averageTime = this.data.conversionTimes.reduce((a, b) => a + b, 0) / this.data.conversionTimes.length;
                
                if (type === 'pdf') this.data.formatBreakdown.pdf++;
                else this.data.formatBreakdown.image++;
                
                if (this.data.styleBreakdown[style] !== undefined) {
                    this.data.styleBreakdown[style]++;
                }
            },
            
            show: function() {
                let modal = document.getElementById('statsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'statsModal';
                    modal.className = 'settings-modal';
                    document.body.appendChild(modal);
                }
                
                modal.innerHTML = `
                    <div class="settings-container" style="max-width: 500px;">
                        <div class="settings-header">
                            <span class="settings-title">📊 轉換統計</span>
                            <button class="preview-close" onclick="Statistics.hide()">✕</button>
                        </div>
                        <div class="settings-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon">🔄</div>
                                    <div class="stat-value">${this.data.totalConverted}</div>
                                    <div class="stat-label">總轉換次數</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">💾</div>
                                    <div class="stat-value">${this.formatSize(this.data.totalSize)}</div>
                                    <div class="stat-label">處理資料量</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">⏱️</div>
                                    <div class="stat-value">${(this.data.averageTime / 1000).toFixed(1)}s</div>
                                    <div class="stat-label">平均轉換時間</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">📄</div>
                                    <div class="stat-value">${this.data.formatBreakdown.pdf}</div>
                                    <div class="stat-label">PDF 檔案</div>
                                </div>
                            </div>
                            
                            <div class="divider"></div>
                            
                            <div class="stats-section">
                                <h4 class="stats-section-title">風格使用分布</h4>
                                <div class="stats-bars">
                                    ${this.renderStyleBars()}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加統計樣式
                this.addStyles();
                
                modal.classList.add('show');
            },
            
            hide: function() {
                const modal = document.getElementById('statsModal');
                if (modal) modal.classList.remove('show');
            },
            
            renderStyleBars: function() {
                const total = Object.values(this.data.styleBreakdown).reduce((a, b) => a + b, 0) || 1;
                const styles = {
                    clean: { name: '簡潔扁平', icon: '✨' },
                    outline: { name: '線稿描邊', icon: '✏️' },
                    gradient: { name: '漸層質感', icon: '🌈' },
                    sketch: { name: '手繪風格', icon: '🖌️' }
                };
                
                return Object.entries(this.data.styleBreakdown).map(([key, value]) => {
                    const percent = (value / total) * 100;
                    const style = styles[key] || { name: key, icon: '📊' };
                    return `
                        <div class="stats-bar-item">
                            <div class="stats-bar-label">
                                <span>${style.icon} ${style.name}</span>
                                <span>${value} (${percent.toFixed(0)}%)</span>
                            </div>
                            <div class="stats-bar-track">
                                <div class="stats-bar-fill" style="width: ${percent}%;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            formatSize: function(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            },
            
            addStyles: function() {
                if (document.getElementById('stats-styles')) return;
                
                const style = document.createElement('style');
                style.id = 'stats-styles';
                style.textContent = `
                    .stats-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 16px;
                        margin-bottom: 20px;
                    }
                    
                    .stat-card {
                        background: var(--bg-tertiary);
                        border: 1px solid var(--border-light);
                        border-radius: var(--radius-md);
                        padding: 20px;
                        text-align: center;
                    }
                    
                    .stat-icon {
                        font-size: 2rem;
                        margin-bottom: 8px;
                    }
                    
                    .stat-value {
                        font-family: var(--font-mono);
                        font-size: 1.5rem;
                        font-weight: 700;
                        color: var(--gold-main);
                        margin-bottom: 4px;
                    }
                    
                    .stat-label {
                        font-size: 0.8rem;
                        color: var(--text-dim);
                    }
                    
                    .stats-section-title {
                        font-size: 0.9rem;
                        color: var(--text-primary);
                        margin-bottom: 16px;
                    }
                    
                    .stats-bars {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }
                    
                    .stats-bar-item {
                        display: flex;
                        flex-direction: column;
                        gap: 6px;
                    }
                    
                    .stats-bar-label {
                        display: flex;
                        justify-content: space-between;
                        font-size: 0.8rem;
                        color: var(--text-secondary);
                    }
                    
                    .stats-bar-track {
                        height: 8px;
                        background: var(--bg-primary);
                        border-radius: 4px;
                        overflow: hidden;
                    }
                    
                    .stats-bar-fill {
                        height: 100%;
                        background: linear-gradient(90deg, var(--gold-main), var(--copper));
                        border-radius: 4px;
                        transition: width 0.5s ease;
                    }
                `;
                document.head.appendChild(style);
            },
            
            reset: function() {
                this.data = {
                    totalConverted: 0,
                    totalSize: 0,
                    averageTime: 0,
                    conversionTimes: [],
                    formatBreakdown: { pdf: 0, image: 0 },
                    styleBreakdown: { clean: 0, outline: 0, gradient: 0, sketch: 0 }
                };
            }
        };
        
        // ============================================
        // 效能監控
        // ============================================
        const Performance = {
            marks: {},
            
            start: function(name) {
                this.marks[name] = performance.now();
            },
            
            end: function(name) {
                if (this.marks[name]) {
                    const duration = performance.now() - this.marks[name];
                    delete this.marks[name];
                    return duration;
                }
                return 0;
            },
            
            measure: async function(name, fn) {
                this.start(name);
                const result = await fn();
                const duration = this.end(name);
                console.log(`⏱️ ${name}: ${duration.toFixed(2)}ms`);
                return { result, duration };
            }
        };
        
        // ============================================
        // 剪貼簿功能
        // ============================================
        const Clipboard = {
            // 複製文字
            copyText: async function(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (err) {
                    // Fallback
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    const success = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    return success;
                }
            },
            
            // 從剪貼簿讀取
            readText: async function() {
                try {
                    return await navigator.clipboard.readText();
                } catch (err) {
                    console.warn('無法讀取剪貼簿:', err);
                    return null;
                }
            },
            
            // 複製圖片
            copyImage: async function(dataUrl) {
                try {
                    const response = await fetch(dataUrl);
                    const blob = await response.blob();
                    await navigator.clipboard.write([
                        new ClipboardItem({ [blob.type]: blob })
                    ]);
                    return true;
                } catch (err) {
                    console.warn('無法複製圖片:', err);
                    return false;
                }
            }
        };
        
        // ============================================
        // 網路狀態監控
        // ============================================
        const NetworkStatus = {
            isOnline: navigator.onLine,
            
            init: function() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    showToast('網路已連線', 'success');
                    updateApiStatus(AppState.apiConnected);
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    showToast('網路已斷線，部分功能可能無法使用', 'warning');
                });
            },
            
            check: function() {
                return this.isOnline;
            }
        };
        
        // 初始化網路監控
        NetworkStatus.init();
        
        // ============================================
        // 全螢幕功能
        // ============================================
        const Fullscreen = {
            isFullscreen: false,
            
            toggle: function() {
                if (this.isFullscreen) {
                    this.exit();
                } else {
                    this.enter();
                }
            },
            
            enter: function() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
                this.isFullscreen = true;
            },
            
            exit: function() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                this.isFullscreen = false;
            }
        };
        
        document.addEventListener('fullscreenchange', () => {
            Fullscreen.isFullscreen = !!document.fullscreenElement;
        });
        
        // ============================================
        // 防抖和節流
        // ============================================
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        // ============================================
        // 格式化工具
        // ============================================
        const Formatter = {
            // 格式化日期
            date: function(date, format = 'YYYY-MM-DD') {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                const seconds = String(d.getSeconds()).padStart(2, '0');
                
                return format
                    .replace('YYYY', year)
                    .replace('MM', month)
                    .replace('DD', day)
                    .replace('HH', hours)
                    .replace('mm', minutes)
                    .replace('ss', seconds);
            },
            
            // 格式化數字
            number: function(num, decimals = 0) {
                return num.toLocaleString('zh-TW', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                });
            },
            
            // 格式化百分比
            percent: function(value, decimals = 0) {
                return (value * 100).toFixed(decimals) + '%';
            },
            
            // 格式化持續時間
            duration: function(ms) {
                if (ms < 1000) return ms + 'ms';
                if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
                if (ms < 3600000) return (ms / 60000).toFixed(1) + 'm';
                return (ms / 3600000).toFixed(1) + 'h';
            }
        };
        
        // ============================================
        // 驗證工具
        // ============================================
        const Validator = {
            // 驗證 API Key 格式
            isValidApiKey: function(key) {
                return key && key.length >= 20 && /^[A-Za-z0-9_-]+$/.test(key);
            },
            
            // 驗證檔案類型
            isValidFileType: function(file, allowedTypes) {
                const ext = file.name.split('.').pop().toLowerCase();
                return allowedTypes.includes(ext);
            },
            
            // 驗證檔案大小
            isValidFileSize: function(file, maxSizeMB) {
                return file.size <= maxSizeMB * 1024 * 1024;
            },
            
            // 驗證 HEX 顏色
            isValidHexColor: function(color) {
                return /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color);
            },
            
            // 驗證數字範圍
            isInRange: function(value, min, max) {
                return value >= min && value <= max;
            }
        };
        
        // ============================================
        // 輔助功能
        // ============================================
        const Accessibility = {
            // 公告訊息（給螢幕閱讀器）
            announce: function(message, priority = 'polite') {
                let announcer = document.getElementById('a11y-announcer');
                if (!announcer) {
                    announcer = document.createElement('div');
                    announcer.id = 'a11y-announcer';
                    announcer.setAttribute('aria-live', priority);
                    announcer.setAttribute('aria-atomic', 'true');
                    announcer.style.cssText = 'position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;';
                    document.body.appendChild(announcer);
                }
                
                announcer.textContent = '';
                setTimeout(() => {
                    announcer.textContent = message;
                }, 100);
            },
            
            // 設定焦點陷阱（Modal 用）
            trapFocus: function(element) {
                const focusableElements = element.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                const firstFocusable = focusableElements[0];
                const lastFocusable = focusableElements[focusableElements.length - 1];
                
                element.addEventListener('keydown', (e) => {
                    if (e.key !== 'Tab') return;
                    
                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusable) {
                            lastFocusable.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastFocusable) {
                            firstFocusable.focus();
                            e.preventDefault();
                        }
                    }
                });
                
                firstFocusable?.focus();
            }
        };
        
        // ============================================
        // 版本資訊
        // ============================================
        const Version = {
            current: '2.0.0',
            build: '20241201',
            
            info: function() {
                return {
                    name: '向量化煉金工坊',
                    version: this.current,
                    build: this.build,
                    author: 'Vector Alchemy Workshop',
                    description: '將像素煉成可編輯的向量黃金'
                };
            },
            
            log: function() {
                const info = this.info();
                console.table(info);
            }
        };
        
        // ============================================
        // 教學導覽
        // ============================================
        function showTutorial() {
            AppState.tutorialStep = 0;
            AppState.tutorialShown = true;
            
            document.getElementById('tutorialOverlay').classList.add('show');
            updateTutorialStep();
        }
        
        function updateTutorialStep() {
            const step = TutorialSteps[AppState.tutorialStep];
            if (!step) {
                skipTutorial();
                return;
            }
            
            // 更新內容
            document.getElementById('tutorialStepLabel').textContent = `步驟 ${AppState.tutorialStep + 1} / ${TutorialSteps.length}`;
            document.getElementById('tutorialTitle').textContent = step.title;
            document.getElementById('tutorialDesc').textContent = step.desc;
            
            // 更新進度點
            const dots = document.querySelectorAll('.tutorial-dot');
            dots.forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i === AppState.tutorialStep) {
                    dot.classList.add('active');
                } else if (i < AppState.tutorialStep) {
                    dot.classList.add('completed');
                }
            });
            
            // 更新按鈕
            const nextBtn = document.getElementById('tutorialNext');
            nextBtn.textContent = AppState.tutorialStep === TutorialSteps.length - 1 ? '完成' : '下一步';
            
            // 定位聚光燈
            const targetEl = document.querySelector(step.target);
            const spotlight = document.getElementById('tutorialSpotlight');
            const popup = document.getElementById('tutorialPopup');
            
            if (targetEl) {
                const rect = targetEl.getBoundingClientRect();
                const padding = 10;
                
                spotlight.style.left = (rect.left - padding) + 'px';
                spotlight.style.top = (rect.top - padding) + 'px';
                spotlight.style.width = (rect.width + padding * 2) + 'px';
                spotlight.style.height = (rect.height + padding * 2) + 'px';
                spotlight.style.display = 'block';
                
                // 定位彈窗
                const popupWidth = 350;
                let popupLeft = rect.right + 20;
                let popupTop = rect.top;
                
                // 如果右邊放不下，放左邊
                if (popupLeft + popupWidth > window.innerWidth - 20) {
                    popupLeft = rect.left - popupWidth - 20;
                }
                
                // 如果左邊也放不下，放下方
                if (popupLeft < 20) {
                    popupLeft = Math.max(20, rect.left);
                    popupTop = rect.bottom + 20;
                }
                
                // 確保不超出螢幕
                popupTop = Math.min(popupTop, window.innerHeight - 300);
                popupTop = Math.max(20, popupTop);
                
                popup.style.left = popupLeft + 'px';
                popup.style.top = popupTop + 'px';
            } else {
                spotlight.style.display = 'none';
                popup.style.left = '50%';
                popup.style.top = '50%';
                popup.style.transform = 'translate(-50%, -50%)';
            }
        }
        
        function nextTutorialStep() {
            if (AppState.tutorialStep < TutorialSteps.length - 1) {
                AppState.tutorialStep++;
                updateTutorialStep();
            } else {
                skipTutorial();
                showToast('教學完成！開始您的向量化之旅吧', 'success');
            }
        }
        
        function skipTutorial() {
            document.getElementById('tutorialOverlay').classList.remove('show');
            AppState.tutorialShown = true;
        }
        
        // ============================================
        // Toast 通知系統
        // ============================================
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            const titles = {
                success: '成功',
                error: '錯誤',
                warning: '警告',
                info: '提示'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${titles[type]}</div>
                    <div class="toast-message">${escapeHtml(message)}</div>
                </div>
                <button class="toast-close" onclick="closeToast(this)">✕</button>
            `;
            
            container.appendChild(toast);
            
            // 自動關閉
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.add('hiding');
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }
        
        function closeToast(btn) {
            const toast = btn.closest('.toast');
            if (toast) {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }
        }
        
        // ============================================
        // 匯出 Modal 物件（供 onclick 使用）
        // ============================================
        const exportModal = {
            show: function() {
                document.getElementById('exportModal').classList.add('show');
            },
            hide: function() {
                document.getElementById('exportModal').classList.remove('show');
            }
        };
        
        // ============================================
        // 清空功能
        // ============================================
        function clearAll() {
            AppState.files = [];
            AppState.outputs = [];
            AppState.currentPreviewIndex = -1;
            AppState.history = [];
            AppState.historyIndex = -1;
            
            renderFileList();
            renderOutputs();
            renderHistory();
            updateUndoRedoButtons();
            
            // 重置畫布
            document.getElementById('canvasEmpty').style.display = 'flex';
            document.getElementById('canvasViewport').style.display = 'none';
            
            showToast('已清空所有內容', 'success');
        }
        
        // ============================================
        // 視窗大小變化處理
        // ============================================
        window.addEventListener('resize', () => {
            // 重新調整縮放
            if (AppState.outputs.length > 0) {
                // fitToWindow(); // 可選：自動調整
            }
            
            // 更新教學定位
            if (document.getElementById('tutorialOverlay').classList.contains('show')) {
                updateTutorialStep();
            }
        });
        
        // ============================================
        // 防止頁面關閉時丟失資料
        // ============================================
        window.addEventListener('beforeunload', (e) => {
            if (AppState.outputs.length > 0 || AppState.files.length > 0) {
                e.preventDefault();
                e.returnValue = '您有未儲存的內容，確定要離開嗎？';
                return e.returnValue;
            }
        });
        
        // ============================================
        // 控制台歡迎訊息
        // ============================================
        console.log('%c⚗️ 向量化煉金工坊 V2', 'font-size: 24px; font-weight: bold; color: #d4a84b;');
        console.log('%cVector Alchemy Workshop', 'font-size: 14px; color: #8b7355; font-style: italic;');
        console.log('%c將像素煉成可編輯的向量黃金', 'font-size: 12px; color: #666;');
        console.log('');
        console.log('🔧 版本: 2.0.0');
        console.log('📖 快捷鍵提示: 按 ? 鍵查看所有快捷鍵');
        console.log('💡 提示: 使用 Ctrl+Z 復原，Ctrl+Y 重做');
    </script>
</body>
</html>
